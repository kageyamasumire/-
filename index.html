import React, { useMemo, useState, useEffect } from "react";

function clampNonNeg(n) { return Number.isFinite(n) && n > 0 ? n : 0; }
function fmt(n, d = 2) { return Number.isFinite(n) ? n.toFixed(d) : "—"; }
const toLocalYMD = (d) => { const y = d.getFullYear(); const m = String(d.getMonth() + 1).padStart(2, "0"); const day = String(d.getDate()).padStart(2, "0"); return `${y}-${m}-${day}`; };
const parseLocalDate = (s) => { const [y, m, d] = s.split("-").map(Number); if (!y || !m || !d) return NaN; return new Date(y, m - 1, d).getTime(); };
const fmtSci = (n) => { if (!Number.isFinite(n)) return "—"; if (n === 0) return "0"; const a = Math.abs(n); if (a >= 1e5 || a < 1e-2) { const exp = Math.floor(Math.log10(a)); const mant = n / Math.pow(10, exp); return `${Math.round(mant * 100) / 100}×10^${exp}`; } return (Math.round(n * 1000) / 1000).toString(); };

const STEPS = {
  adherent: [
    { step: 1, text: "培養液を吸引除去" },
    { step: 2, text: "PBS(-) 3 mL を静かに加え洗浄" },
    { step: 3, text: "PBS(-) を吸引除去" },
    { step: 4, text: "トリプシン/トリプシン-EDTA 2 mL を加える" },
    { step: 5, text: "室温で剥離を観察" },
    { step: 6, text: "培地 2 mL を加え反応停止" },
    { step: 7, text: "ピペッティングで均一化" },
    { step: 8, text: "細胞浮遊液を 15 mL 遠沈管へ移す" },
    { step: 9, text: "遠心 190–200 g（約1,000 rpm）3 分" },
    { step: 10, text: "上清を吸引除去し、ペレットをタッピングでほぐす" },
    { step: 11, text: "培地 2 mL でピペッティング（0.2 mL を計数用に取り別け）" },
    { step: 12, text: "細胞計数・必要液量の計算" },
    { step: 13, text: "播種：T-25 へ 5 mL 等、容器に応じて分注" },
    { step: 14, text: "顕微鏡で状態確認 → CO₂インキュベータへ" },
  ],
  suspension: [
    { step: 1, text: "フラスコを軽く振って細胞を懸濁" },
    { step: 2, text: "必要量を新しいフラスコに移す（例: 1/5量を分ける）" },
    { step: 3, text: "新しい培地を加えて体積を調整" },
    { step: 4, text: "37℃ CO₂インキュベーターで培養再開" },
  ],
  thaw: [
    { step: 1, text: "培地 9 mL を15 mL チューブに入れ、氷に立てて冷却" },
    { step: 2, text: "凍結バイアルを37℃ ウォーターバスで素早く融解（米粒2つ程度の氷が残るまで）" },
    { step: 3, text: "アルコールで外側を拭き、クリーンベンチ内へ搬入" },
    { step: 4, text: "融解した細胞液を15 mL チューブに移し、共洗い（5 mLメスピペット使用）" },
    { step: 5, text: "遠心 1,000 rpm 3分 4℃" },
    { step: 6, text: "10 cm シャーレに 9 mL、T-25フラスコに 4 mL の培地を準備" },
    { step: 7, text: "遠心後、0.5 mL残して上清を捨てる" },
    { step: 8, text: "ペレットを2回タッピング（やりすぎ注意）" },
    { step: 9, text: "同じ培地 2 mL を加えて再懸濁" },
    { step: 10, text: "フラスコとシャーレにそれぞれ 1 mL ずつ播種" },
    { step: 11, text: "インキュベーターへ（フラスコはキャップを少し開ける）" },
    { step: 12, text: "細胞名・日付・氏名をラベル記入" },
    { step: 13, text: "細胞計数を行い終了" },
  ],
  freeze: [
    { step: 1, text: "培養液を吸引除去" },
    { step: 2, text: "PBS(-) 3 mL を静かに加える" },
    { step: 3, text: "PBS(-) を吸引除去" },
    { step: 4, text: "トリプシン液 2 mL を加え室温放置" },
    { step: 5, text: "検鏡（剥離確認）" },
    { step: 6, text: "アルコール面で拭きクリーンベンチへ" },
    { step: 7, text: "培地 2 mL を加えピペッティングでほぐす" },
    { step: 8, text: "細胞浮遊液 4 mL を15 mL遠心管へ（0.2 mLを計数用に分取）" },
    { step: 9, text: "細胞計数・1.0×10^6 cells/mL となる液量を算出" },
    { step: 10, text: "遠心(1000 rpm, 3分, 4℃)→上清除去→ペレットをタッピング" },
    { step: 11, text: "算出量の氷冷した凍結用培地で再懸濁" },
    { step: 12, text: "2本のバイアルに各1 mL 分注" },
    { step: 13, text: "凍結用断熱容器に入れる" },
    { step: 14, text: "液体窒素タンクに収納" },
  ],
};

function StepCard({ step, text, role, checked, onToggle }) {
  return (
    <div className="border rounded-lg p-3 bg-white shadow-sm text-center">
      <div className="flex items-center justify-center gap-2 mb-1">
        <input type="checkbox" checked={checked} onChange={onToggle} className="w-5 h-5 accent-emerald-600"/>
        <div className="font-semibold">Step {step}</div>
      </div>
      <div className="text-sm text-slate-700 whitespace-pre-line">{text}</div>
      {role && <div className="text-xs text-slate-500 mt-1">{role}</div>}
    </div>
  );
}
function Arrow() { return <div className="flex justify-center text-2xl text-slate-400">↓</div>; }

function SterilizationView() {
  const [selItem, setSelItem] = useState("溶液・培地(熱変性を起こさない)");
  const ITEMS = {
    "溶液・培地(熱変性を起こさない)": ["オートクレーブ滅菌"],
    "溶液・培地(熱に弱い/成分変性の恐れ)": ["ろ過滅菌(0.2µm)"],
    "ビタミン類": ["ろ過滅菌(0.2µm)"],
    "血清": ["ろ過滅菌(0.2µm)", "4℃遮光、凍結融解回数最小化"],
    "ガラス器具(オートクレーブ)": ["121℃ 20分", "キャップ緩め/アルミ箔"],
    "ガラス器具(乾熱)": ["175℃ 1.5時間", "室温近くまで扉を開けない"],
    "金属器具(オートクレーブ)": ["121℃ 20分", "耐熱なら火炎滅菌可"],
    "白金耳/白金線": ["炎焼却(フレーム)"],
    "ピペットチップ": ["滅菌済み推奨", "PPはオートクレーブ可"],
    "マイクロチューブ": ["滅菌済み推奨", "PPはオートクレーブ可(変形注意)"],
    "遠心管": ["PP: オートクレーブ可", "PS: 不可/滅菌済み使用"],
    "シャーレ": ["PS: オートクレーブ不可/滅菌済み使い捨て"],
    "微生物での汚染物の廃棄": ["オートクレーブ後に廃棄", "液体は必要に応じ次亜塩素酸で前処理"],
  };
  const methodLines = ITEMS[selItem] || [];
  return (
    <div className="space-y-3">
      <label className="flex flex-col text-sm">
        <span>対象物</span>
        <select className="border rounded-lg p-2" value={selItem} onChange={(e) => setSelItem(e.target.value)}>
          {Object.keys(ITEMS).map((it) => (
            <option key={it} value={it}>{it}</option>
          ))}
        </select>
      </label>
      <div className="rounded-xl border border-slate-200 p-3">
        <div className="font-semibold mb-2">推奨される滅菌方法</div>
        <ul className="list-disc ml-6 text-sm">
          {methodLines.map((m, i) => (
            <li key={i}>{m}</li>
          ))}
        </ul>
        <div className="text-xs text-slate-600 mt-2">最終判断は研究室のSOP・施設規程に従ってください。</div>
      </div>
    </div>
  );
}

function ReagentPrepView() {
  const [sel, setSel] = useState("MEM培地");
  const [vol, setVol] = useState(100);

  const recipes = {
    "MEM培地": {
      role: "基本培地。添付文書/SOPに従って添加剤を必要に応じて調整。",
      baseV: 100,
      items: [
        { name: "MEM粉末", amt: 0.94, unit: "g" },
        { name: "Milli-Q水", amt: 100, unit: "mL" },
      ],
      method: ["オートクレーブ滅菌", "冷蔵保存"],
      steps: (V) => [
        `MEM粉末 ${Math.round(0.94 * V / 100 * 1000) / 1000} g を量りビンへ`,
        `Milli-Q水 ${V} mL を加え溶解`,
        "ラベルとオートクレーブテープを貼る",
        "オートクレーブ滅菌 → 冷蔵保管",
      ],
    },
    "RPMI1640培地": {
      role: "培地。浮遊系の細胞の培養で使われる。",
      baseV: 100,
      items: [
        { name: "RPMI1640粉末", amt: 1.02, unit: "g" },
        { name: "Milli-Q水", amt: 100, unit: "mL" },
      ],
      method: ["オートクレーブ滅菌", "冷蔵保存"],
      steps: (V) => [
        `RPMI1640粉末 ${Math.round(1.02 * V / 100 * 1000) / 1000} g を量りビンへ`,
        `Milli-Q水 ${V} mL を加え溶解`,
        "ラベルとオートクレーブテープを貼る",
        "オートクレーブ滅菌 → 冷蔵保管",
      ],
    },
    "10% NaHCO₃": {
      role: "pH を調整する目的で添加する炭酸水素ナトリウム溶液。",
      baseV: 100,
      items: [
        { name: "NaHCO₃", amt: 10.0, unit: "g" },
        { name: "超純水", amt: 100, unit: "mL" },
      ],
      method: ["撹拌溶解", "オートクレーブ滅菌"],
      steps: (V) => [
        `NaHCO₃ ${Math.round(10.0 * V / 100 * 1000) / 1000} g を量り ${V} mLビンへ`,
        "スターラーで撹拌し溶解",
        "オートクレーブ滅菌",
      ],
    },
    "3% L-グルタミン": {
      role: "細胞の栄養素。培地に添加して使用する。",
      baseV: 10,
      items: [
        { name: "L-グルタミン", amt: 0.3, unit: "g" },
        { name: "超純水", amt: 10, unit: "mL" },
      ],
      method: ["0.22 µm ろ過滅菌", "冷蔵保存"],
      steps: (V) => [
        `超純水 ${V} mL を15 mLチューブへ`,
        `L-グルタミン ${Math.round(0.3 * V / 10 * 1000) / 1000} g を加え溶解`,
        "0.22 µmフィルターでろ過滅菌",
        "ラベルして冷蔵保管",
      ],
    },
    "100 mg/mL ストレプトマイシン": {
      role: "抗生物質。バクテリアに有効。細胞毒性があるため濃度管理に注意。",
      baseV: 5,
      items: [
        { name: "ストレプトマイシン", amt: 0.5, unit: "g" },
        { name: "超純水", amt: 5, unit: "mL" },
      ],
      method: ["0.22 µm ろ過滅菌", "分注し冷凍保存"],
      steps: (V) => [
        `超純水 ${V} mL を15 mLチューブへ`,
        `ストレプトマイシン ${Math.round(0.5 * V / 5 * 1000) / 1000} g を溶解`,
        "0.22 µmフィルターでろ過滅菌",
        "滅菌15 mLチューブに分注し冷凍保存",
      ],
    },
    "100,000 U/mL ペニシリン": {
      role: "抗生物質。バクテリアに有効。力価換算・濃度に注意。",
      baseV: 5,
      items: [
        { name: "ペニシリン（力価合計）", amt: 500000, unit: "U" },
        { name: "超純水", amt: 5, unit: "mL" },
      ],
      method: ["0.22 µm ろ過滅菌", "分注し冷凍保存"],
      steps: (V) => [
        `超純水 ${V} mL を15 mLチューブへ`,
        `ペニシリン ${Math.round(500000 * V / 5)} U 相当量を溶解（製品規定で換算）`,
        "0.22 µmフィルターでろ過滅菌",
        "滅菌15 mLチューブに分注し冷凍保存",
      ],
    },
    "0.4% トリパンブルー": {
      role: "死細胞は色素を排除できずに染色される性質を利用し、細胞の生死判定に用いる溶液。",
      baseV: 100,
      items: [
        { name: "トリパンブルー粉末", amt: 0.4, unit: "g" },
        { name: "超純水", amt: 100, unit: "mL" },
      ],
      method: ["0.22 µm ろ過滅菌", "暗所保存"],
      steps: (V) => [
        `トリパンブルー粉末 ${Math.round(0.4 * V / 100 * 1000) / 1000} g を量る`,
        `超純水 ${V} mL に溶解`,
        "0.22 µmフィルターでろ過",
        "暗所保存",
      ],
    },
    "1× PBS(-)": {
      role: "細胞を洗う緩衝液（Ca²⁺/Mg²⁺を含まない）。",
      baseV: 500,
      items: [
        { name: "NaCl", amt: 4.0, unit: "g" },
        { name: "KCl", amt: 0.1, unit: "g" },
        { name: "Na₂HPO₄·12H₂O", amt: 1.45, unit: "g" },
        { name: "KH₂PO₄", amt: 0.1, unit: "g" },
        { name: "超純水で定容", amt: 500, unit: "mL" },
      ],
      method: ["オートクレーブ滅菌", "冷蔵保存"],
      steps: (V) => [
        `超純水をビーカーに取り溶解、${V} mL にメスアップ`,
        `NaCl ${Math.round(4.0 * V / 500 * 1000) / 1000} g、KCl ${Math.round(0.1 * V / 500 * 1000) / 1000} g、Na₂HPO₄·12H₂O ${Math.round(1.45 * V / 500 * 1000) / 1000} g、KH₂PO₄ ${Math.round(0.1 * V / 500 * 1000) / 1000} g`,
        "ラベルしオートクレーブ滅菌",
        "冷蔵保存",
      ],
    },
    "10× PBS": {
      role: "PBS の10倍濃縮ストック。使用時に1×へ希釈。",
      baseV: 1000,
      items: [
        { name: "NaCl", amt: 80, unit: "g" },
        { name: "KCl", amt: 2, unit: "g" },
        { name: "Na₂HPO₄·12H₂O", amt: 28.8, unit: "g" },
        { name: "KH₂PO₄", amt: 2, unit: "g" },
        { name: "超純水で定容", amt: 1000, unit: "mL" },
      ],
      method: ["オートクレーブ滅菌", "冷蔵保存"],
      steps: (V) => [
        `各塩を秤量し溶解、${V} mL にメスアップ`,
        `NaCl ${Math.round(80 * V / 1000 * 1000) / 1000} g、KCl ${Math.round(2 * V / 1000 * 1000) / 1000} g、Na₂HPO₄·12H₂O ${Math.round(28.8 * V / 1000 * 1000) / 1000} g、KH₂PO₄ ${Math.round(2 * V / 1000 * 1000) / 1000} g`,
        "ラベルしオートクレーブ滅菌 → 冷蔵",
      ],
    },
    "10× TBE": {
      role: "電気泳動用バッファの10倍ストック。使用時に1×へ希釈。",
      baseV: 1000,
      items: [
        { name: "Tris base", amt: 108, unit: "g" },
        { name: "Boric acid", amt: 55, unit: "g" },
        { name: "0.5 M EDTA (pH 8.0)", amt: 40, unit: "mL" },
        { name: "超純水で定容", amt: 1000, unit: "mL" },
      ],
      method: ["撹拌溶解", "ろ過/オートクレーブはSOP準拠"],
      steps: (V) => [
        `Tris ${Math.round(108 * V / 1000 * 1000) / 1000} g、Boric acid ${Math.round(55 * V / 1000 * 1000) / 1000} g を溶解`,
        `0.5 M EDTA(pH8.0) ${Math.round(40 * V / 1000 * 1000) / 1000} mL を加える`,
        `${V} mL にメスアップし混和`,
      ],
    },
  };

  const r = recipes[sel];
  const scaled = r.items.map((it) => {
    const factor = vol / r.baseV;
    const val = Math.round(it.amt * factor * 1000) / 1000;
    return { ...it, val };
  });
  const steps = r.steps ? r.steps(vol) : [];

  return (
    <div className="space-y-3">
      <h2 className="font-semibold">試薬の調整</h2>
      <div className="grid md:grid-cols-2 gap-3">
        <label className="flex flex-col text-sm">
          <span>レシピ</span>
          <select
            className="border rounded p-2"
            value={sel}
            onChange={(e) => setSel(e.target.value)}
          >
            {Object.keys(recipes).map((k) => (
              <option key={k} value={k}>
                {k}
              </option>
            ))}
          </select>
          <div className="text-xs text-slate-600 mt-1">※ 役割: {r.role}</div>
        </label>

        <label className="flex flex-col text-sm">
          <span>目標体積 (mL)</span>
          <input
            className="border rounded p-2"
            type="number"
            min={1}
            value={vol}
            onChange={(e) => setVol(Math.max(1, Number(e.target.value)))}
          />
        </label>
      </div>

      <div className="rounded border p-3 text-sm">
        <div className="font-semibold mb-1">計量リスト（{vol} mL）</div>
        <ul className="list-disc ml-6">
          {scaled.map((it, i) => (
            <li key={i}>
              {it.name}: {it.val} {it.unit}
            </li>
          ))}
        </ul>

        <div className="mt-3 font-semibold">手順</div>
        <ol className="list-decimal ml-6 space-y-1">
          {steps.map((s, i) => (
            <li key={i}>{s}</li>
          ))}
        </ol>

        <div className="text-xs text-slate-600 mt-2">※ 役割: {r.role}</div>
        <div className="text-xs text-slate-600 mt-1">
          最終判断はSOP・添付文書に従う。方法: {(r.method || []).join(" / ")}
        </div>
      </div>
    </div>
  );
}

function StockSolutionsView() {
  const [C1, setC1] = useState(100);
  const [C2, setC2] = useState(10);
  const [V2, setV2] = useState(100);
  const V1 = C1 > 0 ? (C2 * V2) / C1 : 0;
  const Vd = Math.max(0, V2 - V1);
  const [pct, setPct] = useState(1);
  const [VmL, setVmL] = useState(100);
  const grams = (pct / 100) * VmL;

  return (
    <div className="space-y-4">
      <h2 className="font-semibold">ストック溶液の調整</h2>
      <div className="rounded border p-3 text-sm space-y-2">
        <div className="font-medium">希釈計算 (C1V1 = C2V2)</div>
        <div className="grid md:grid-cols-4 gap-2">
          <label> C1<input className="border p-1 w-full" type="number" value={C1} onChange={(e)=>setC1(Number(e.target.value))} /></label>
          <label> C2<input className="border p-1 w-full" type="number" value={C2} onChange={(e)=>setC2(Number(e.target.value))} /></label>
          <label> V2(mL)<input className="border p-1 w-full" type="number" value={V2} onChange={(e)=>setV2(Number(e.target.value))} /></label>
          <div className="flex items-end gap-2"><div className="border rounded p-2 w-full">V1(加えるストック): {V1.toFixed(2)} mL</div></div>
        </div>
        <div className="text-xs">希釈溶媒: {Vd.toFixed(2)} mL</div>
      </div>
      <div className="rounded border p-3 text-sm space-y-2">
        <div className="font-medium">% w/v 計算</div>
        <div className="grid md:grid-cols-3 gap-2">
          <label>% <input className="border p-1 w-full" type="number" value={pct} onChange={(e)=>setPct(Number(e.target.value))} /></label>
          <label>体積(mL) <input className="border p-1 w-full" type="number" value={VmL} onChange={(e)=>setVmL(Number(e.target.value))} /></label>
          <div className="flex items-end"><div className="border rounded p-2 w-full">秤量: {grams.toFixed(3)} g</div></div>
        </div>
      </div>
    </div>
  );
}

function MolarityCalcView() {
  const [solute, setSolute] = useState("Tris-HCl");
  const [mwStr, setMwStr] = useState("121.14");
  const [mStr, setMStr] = useState("1.5");
  const [volStr, setVolStr] = useState("100");
  const mw = clampNonNeg(parseFloat(mwStr));
  const M = clampNonNeg(parseFloat(mStr));
  const vol = clampNonNeg(parseFloat(volStr));
  const L = vol / 1000; const grams = M * L * mw;
  const formulaText = useMemo(() => `重さ(g) = 濃度(M) × 体積(L) × 分子量(g/mol)\n         = ${M} × ${L.toFixed(3)} × ${mw}\n         = ${fmt(grams, 2)} g`, [M, L, mw, grams]);

  return (
    <div className="space-y-4">
      <h2 className="font-semibold">モル濃度計算（文章で入力）</h2>
      <div className="rounded border p-3 text-base leading-relaxed flex flex-wrap items-center gap-2">
        <span>濃度</span>
        <input type="number" step="0.1" className="mx-1 w-24 border rounded p-1 text-right" value={mStr} onChange={(e)=>setMStr(e.target.value)} />
        <span>M の</span>
        <input type="text" className="mx-1 w-48 border rounded p-1" value={solute} onChange={(e)=>setSolute(e.target.value)} />
        <span>（分子量</span>
        <input type="number" step="0.01" className="mx-1 w-28 border rounded p-1 text-right" value={mwStr} onChange={(e)=>setMwStr(e.target.value)} />
        <span>g/mol）を</span>
        <input type="number" className="mx-1 w-28 border rounded p-1 text-right" value={volStr} onChange={(e)=>setVolStr(e.target.value)} />
        <span>mL 欲しい！</span>
        <div className="w-full text-xs text-rose-700 mt-1">※ 分子量は必ず瓶ラベル・添付文書を確認してください。</div>
      </div>
      <div className="rounded border p-3 bg-slate-50 text-sm space-y-2">
        <div className="font-medium">計算式:</div>
        <pre className="whitespace-pre-wrap">{formulaText}</pre>
        <div className="font-medium mt-2">結果:</div>
        <p>{solute} を <strong>{fmt(grams, 2)} g</strong> はかって、水に溶かし、全体を {fmt(vol, 0)} mL にしてください。</p>
        <div className="rounded bg-sky-50 p-2 mt-2">
          <div className="font-semibold mb-1">やさしい解説</div>
          <ol className="list-decimal ml-5 space-y-1">
            <li>{fmt(vol, 0)} mL は L に直すと {L.toFixed(3)} L。</li>
            <li>モル数 = 濃度 {M} × 体積 {L.toFixed(3)} L = {fmt(M * L, 3)} mol。</li>
            <li>{solute} 1 mol は {mw} g。だから {fmt(M * L, 3)} mol は {fmt(grams, 2)} g。</li>
          </ol>
        </div>
      </div>
    </div>
  );
}

function VesselDataView() {
  const rows = [
    { name: "T-25 フラスコ", area: 25, vol: "3–7", seed: "2–5×10^4/cm²" },
    { name: "T-75 フラスコ", area: 75, vol: "10–20", seed: "2–5×10^4/cm²" },
    { name: "T-175 フラスコ", area: 175, vol: "25–50", seed: "2–5×10^4/cm²" },
    { name: "6-well", area: 9.6, vol: "2–3 mL/ウェル", seed: "1–3×10^5/ウェル" },
    { name: "12-well", area: 3.8, vol: "1–2 mL/ウェル", seed: "0.5–1×10^5/ウェル" },
    { name: "24-well", area: 1.9, vol: "0.5–1 mL/ウェル", seed: "2–5×10^4/ウェル" },
    { name: "96-well", area: 0.32, vol: "0.1–0.25 mL/ウェル", seed: "5–20×10^3/ウェル" },
    { name: "10 cm ディッシュ", area: 56.7, vol: "8–12", seed: "2–5×10^6/皿" },
  ];
  return (
    <div className="space-y-3">
      <h2 className="font-semibold">培養容器データ集</h2>
      <table className="w-full text-sm border">
        <thead className="bg-slate-50"><tr><th className="px-2 py-1 text-left">容器</th><th className="px-2 py-1 text-left">増殖面積(cm²)</th><th className="px-2 py-1 text-left">目安液量(mL)</th><th className="px-2 py-1 text-left">播種目安</th></tr></thead>
        <tbody>{rows.map((r,i)=> (<tr key={i} className="border-t"><td className="px-2 py-1">{r.name}</td><td className="px-2 py-1">{r.area}</td><td className="px-2 py-1">{r.vol}</td><td className="px-2 py-1">{r.seed}</td></tr>))}</tbody>
      </table>
      <div className="text-xs text-slate-600">メーカー差があるためSOP/製品仕様を確認してください。</div>
    </div>
  );
}

function CellCountView() {
  const [liveSum, setLiveSum] = useState(0);
  const [deadSum, setDeadSum] = useState(0);
  const [cellVol, setCellVol] = useState(0);
  const [tbVol, setTbVol] = useState(0);
  const [tubeVol, setTubeVol] = useState(0);
  const [cultureVol, setCultureVol] = useState(0);
  const [targetConc, setTargetConc] = useState(0);
  const squares = 4;
  const liveAvg = liveSum / squares;
  const deadAvg = deadSum / squares;
  const totalAvg = liveAvg + deadAvg;
  const df = cellVol > 0 ? (cellVol + tbVol) / cellVol : 1;
  const liveConc = liveAvg * df * 1e4;
  const totalConc = totalAvg * df * 1e4;
  const viability = totalAvg > 0 ? (liveAvg / totalAvg) * 100 : 0;
  const totalCellsInTube = totalConc * tubeVol;
  const liveCellsInCulture = liveConc * cultureVol;
  const needCellVol = liveConc > 0 ? (targetConc / liveConc) * cultureVol : 0;
  const needMedia = cultureVol - needCellVol;
  const fmtExp = (x) => (Number.isFinite(x) && x > 0 ? x.toExponential(2) : "0");
  return (
    <div className="space-y-3">
      <h2 className="font-semibold">細胞数/生存率 計算</h2>
      <div className="grid grid-cols-2 gap-2">
        <label>生細胞数合計<input type="number" value={liveSum} onChange={(e) => setLiveSum(Number(e.target.value))} className="border p-1" /></label>
        <label>死細胞数合計<input type="number" value={deadSum} onChange={(e) => setDeadSum(Number(e.target.value))} className="border p-1" /></label>
        <label>細胞液量(µL)<input type="number" value={cellVol} onChange={(e) => setCellVol(Number(e.target.value))} className="border p-1" /></label>
        <label>トリパンブルー量(µL)<input type="number" value={tbVol} onChange={(e) => setTbVol(Number(e.target.value))} className="border p-1" /></label>
        <label>凍結チューブ体積(mL)<input type="number" value={tubeVol} onChange={(e) => setTubeVol(Number(e.target.value))} className="border p-1" /></label>
        <label>培養容器液量(mL)<input type="number" value={cultureVol} onChange={(e) => setCultureVol(Number(e.target.value))} className="border p-1" /></label>
        <label>目標濃度(cells/mL)<input type="number" value={targetConc} onChange={(e) => setTargetConc(Number(e.target.value))} className="border p-1" /></label>
      </div>
      <div className="border rounded p-2 text-sm space-y-1">
        <p>生平均: {liveAvg}</p>
        <p>死平均: {deadAvg}</p>
        <p>全平均: {totalAvg}</p>
        <p>生存率: {viability.toFixed(1)}%</p>
        <p>生細胞濃度: {fmtExp(liveConc)} cells/mL</p>
        <p>全細胞濃度: {fmtExp(totalConc)} cells/mL</p>
        <p>凍結チューブ中の全細胞数: {fmtExp(totalCellsInTube)}</p>
        <p>培養容器内の生細胞数: {fmtExp(liveCellsInCulture)}</p>
        <p>継代培養に必要な細胞液量: {Number.isFinite(needCellVol) ? needCellVol.toFixed(2) : "0"} mL</p>
        <p>継代培養に必要な培地: {Number.isFinite(needMedia) ? needMedia.toFixed(2) : "0"} mL</p>
      </div>
    </div>
  );
}

function CalendarCultureScheduler() {
  const today = toLocalYMD(new Date());
  const [doublingH, setDoublingH] = useState("12");
  const [c0, setC0] = useState("1e5");
  const [neededCells, setNeededCells] = useState("1e5");
  const [neededVol, setNeededVol] = useState("1");
  const [startDate, setStartDate] = useState(today);
  const [expDate, setExpDate] = useState(toLocalYMD(new Date(Date.now() + 7*24*3600*1000)));
  const [passages, setPassages] = useState([{ date: toLocalYMD(new Date(Date.now() + 3*24*3600*1000)), df: "20" }]);

  const addPassage = () => setPassages((prev) => [...prev, { date: today, df: "2" }]);
  const updatePassageDate = (i, v) => setPassages((prev) => prev.map((p, idx) => idx === i ? { ...p, date: v } : p));
  const updatePassageDF = (i, v) => setPassages((prev) => prev.map((p, idx) => idx === i ? { ...p, df: v } : p));
  const removePassage = (i) => setPassages((prev) => prev.filter((_, idx) => idx !== i));

  const Td = Number(doublingH);
  const C0 = Number(c0);
  const targetCells = Number(neededCells);
  const targetVol = Number(neededVol);
  const targetConc = targetCells / Math.max(1e-9, targetVol);

  const startTs = parseLocalDate(startDate);
  const expTs = parseLocalDate(expDate);
  const days = Number.isFinite(startTs) && Number.isFinite(expTs) ? Math.max(0, Math.round((expTs - startTs) / (24*3600*1000))) : 0;
  const dailyFactor = Td > 0 ? Math.pow(2, 24 / Td) : NaN;

  const dfByDate = passages.reduce((acc, p) => {
    if (!p.date) return acc;
    const df = parseFloat(p.df);
    if (!Number.isFinite(df) || df <= 0) return acc;
    acc[p.date] = (acc[p.date] || 1) * df;
    return acc;
  }, {});

  let current = C0;
  const rows = [];
  for (let k = 0; k <= days; k++) {
    const d = new Date(startTs + k * 24*3600*1000);
    const ymd = toLocalYMD(d);
    if (k === 0) { } else { current = Number.isFinite(dailyFactor) ? current * dailyFactor : NaN; }
    const before = current;
    let after = undefined;
    const df = dfByDate[ymd];
    if (Number.isFinite(before) && Number.isFinite(df)) {
      after = before / df;
      current = after;
    }
    rows.push({ date: ymd, before, df, after });
  }

  return (
    <div className="space-y-4">
      <h2 className="text-lg font-semibold">細胞培養計画スケジューラ</h2>

      <div className="grid md:grid-cols-3 gap-3">
        <label className="flex flex-col text-sm"><span>開始日</span><input type="date" value={startDate} onChange={(e)=>setStartDate(e.target.value)} /></label>
        <label className="flex flex-col text-sm"><span>実験日</span><input type="date" value={expDate} onChange={(e)=>setExpDate(e.target.value)} /></label>
        <div className="flex flex-col text-sm gap-1">
          <span>継代日</span>
          {passages.map((p,i)=> (
            <div key={i} className="flex items-center gap-2">
              <input type="date" value={p.date} onChange={(e)=>updatePassageDate(i, e.target.value)} />
              <span>希釈</span>
              <input type="number" step="0.1" className="border rounded p-1 w-24 text-right" value={p.df} onChange={(e)=>updatePassageDF(i, e.target.value)} />
              <span>倍</span>
              <button onClick={()=>removePassage(i)} className="text-red-600">削除</button>
            </div>
          ))}
          <button onClick={addPassage} className="bg-emerald-500 text-white rounded px-2 py-1 text-sm">＋追加</button>
        </div>
      </div>

      <div className="grid md:grid-cols-4 gap-3">
        <label className="flex flex-col text-sm"><span>倍加時間 (h)</span><input type="number" value={doublingH} onChange={(e)=>setDoublingH(e.target.value)} /></label>
        <label className="flex flex-col text-sm"><span>開始濃度 C0 (cells/mL)</span><input type="number" value={c0} onChange={(e)=>setC0(e.target.value)} /></label>
        <label className="flex flex-col text-sm"><span>実験に必要な細胞濃度 (cells/mL)</span><input type="number" value={neededCells} onChange={(e)=>setNeededCells(e.target.value)} /></label>
        <label className="flex flex-col text-sm"><span>実験に必要な液量 (mL)</span><input type="number" value={neededVol} onChange={(e)=>setNeededVol(e.target.value)} /></label>
      </div>

      <table className="min-w-full text-sm border border-slate-200 bg-white">
        <thead className="bg-slate-50">
          <tr>
            <th className="px-2 py-1 text-left">日にち</th>
            <th className="px-2 py-1 text-left">細胞濃度（前）</th>
            <th className="px-2 py-1 text-left">希釈</th>
            <th className="px-2 py-1 text-left">細胞濃度（後）</th>
          </tr>
        </thead>
        <tbody>
          {rows.map((r, i) => (
            <tr key={i} className="border-t">
              <td className="px-2 py-1">{r.date}</td>
              <td className="px-2 py-1">{fmtSci(r.before)} cells/mL</td>
              <td className="px-2 py-1">{Number.isFinite(r.df) ? `${r.df}倍希釈` : ""}</td>
              <td className="px-2 py-1">{Number.isFinite(r.after) ? `${fmtSci(r.after)} cells/mL` : ""}</td>
            </tr>
          ))}
        </tbody>
      </table>

      <div className="rounded border p-3 bg-white text-xs space-y-1">
        <div>1日あたりの増殖率: {Number.isFinite(dailyFactor) ? `${(Math.round(dailyFactor*100)/100)}×` : "—"}</div>
        <div>目標濃度: {fmtSci(targetConc)} cells/mL</div>
        <div className="text-slate-600">※ 希釈はその日の行内で実施し、翌日の増殖は希釈後濃度を基準に計算します。</div>
      </div>
    </div>
  );
}

export default function App() {
  const [mode, setMode] = useState("adherent");
  const [checks, setChecks] = useState({ type: "adherent", map: {} });
  useEffect(()=>{ setChecks((c)=> ({...c, map: {}})); }, [mode]);

  const list = STEPS[mode] || [];
  const toggleCheck = (k) => setChecks((c)=> ({...c, map: {...c.map, [k]: !c.map[k]}}));

  return (
    <div className="max-w-3xl mx-auto p-4 space-y-4">
      <h1 className="text-xl font-bold">細胞継代・融解・凍結・滅菌・計算・計画・試薬/ストック/容器</h1>
      <div className="flex gap-2 flex-wrap">
        <button onClick={() => setMode("adherent")} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${mode === "adherent" ? "bg-blue-600 text-white" : "bg-slate-200"}`}>付着細胞</button>
        <button onClick={() => setMode("suspension")} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${mode === "suspension" ? "bg-blue-600 text-white" : "bg-slate-200"}`}>浮遊細胞</button>
        <button onClick={() => setMode("thaw")} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${mode === "thaw" ? "bg-blue-600 text-white" : "bg-slate-200"}`}>凍結細胞の融解</button>
        <button onClick={() => setMode("freeze")} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${mode === "freeze" ? "bg-blue-600 text-white" : "bg-slate-200"}`}>凍結保存</button>
        <button onClick={() => setMode("sterilize")} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${mode === "sterilize" ? "bg-blue-600 text-white" : "bg-slate-200"}`}>滅菌方法</button>
        <button onClick={() => setMode("reagents")} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${mode === "reagents" ? "bg-blue-600 text-white" : "bg-slate-200"}`}>試薬の調整</button>
        <button onClick={() => setMode("stocks")} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${mode === "stocks" ? "bg-blue-600 text-white" : "bg-slate-200"}`}>ストック溶液</button>
        <button onClick={() => setMode("molar")} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${mode === "molar" ? "bg-blue-600 text-white" : "bg-slate-200"}`}>モル濃度計算</button>
        <button onClick={() => setMode("vessels")} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${mode === "vessels" ? "bg-blue-600 text-white" : "bg-slate-200"}`}>培養容器データ</button>
        <button onClick={() => setMode("count")} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${mode === "count" ? "bg-blue-600 text-white" : "bg-slate-200"}`}>細胞数/生存率</button>
        <button onClick={() => setMode("plan")} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${mode === "plan" ? "bg-blue-600 text-white" : "bg-slate-200"}`}>細胞培養計画</button>
      </div>

      {mode === "sterilize" ? (
        <SterilizationView />
      ) : mode === "reagents" ? (
        <ReagentPrepView />
      ) : mode === "stocks" ? (
        <StockSolutionsView />
      ) : mode === "molar" ? (
        <MolarityCalcView />
      ) : mode === "vessels" ? (
        <VesselDataView />
      ) : mode === "count" ? (
        <CellCountView />
      ) : mode === "plan" ? (
        <CalendarCultureScheduler />
      ) : (
        <div className="space-y-2">
          {list.map((s, idx) => (
            <React.Fragment key={s.step}>
              <StepCard
                step={s.step}
                text={s.text}
                role={s.role}
                checked={!!checks.map[s.step]}
                onToggle={() => toggleCheck(s.step)}
              />
              {idx < list.length - 1 && <Arrow />}
            </React.Fragment>
          ))}
        </div>
      )}

      <div className="text-xs text-slate-600">SOPと施設規程を最優先してください。</div>
    </div>
  );
}
