<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ã‹ã‚“ãŸã‚“ç´°èƒã‘ã„ã•ã‚“ï¼ˆè¶…ã‚„ã•ã—ã„ç‰ˆï¼‰</title>
<style>
  :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --accent:#38bdf8; --text:#e5e7eb; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",Arial;}
  header{padding:18px 20px; border-bottom:1px solid #1f2937; background:linear-gradient(180deg,#0b1222,#0f172a 60%);}
  h1{margin:0; font-size:clamp(20px,4.5vw,28px)}
  main{max-width:980px; margin:0 auto; padding:16px}
  section{background:rgba(17,24,39,.7); border:1px solid #233044; border-radius:16px; padding:14px; margin-bottom:16px}
  h2{margin:0 0 10px 0; font-size:18px}
  .grid{display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
  .field{display:flex; flex-direction:column; gap:6px;}
  label{font-size:13px; color:var(--muted)}
  input,button{border:1px solid #2a3a52; background:#0b1222; color:var(--text); border-radius:12px; padding:12px; font-size:16px; outline:none}
  input:focus{border-color:var(--accent); box-shadow:0 0 0 2px rgba(56,189,248,.15)}
  button{cursor:pointer; background:#1e293b}
  table{width:100%; border-collapse:collapse; font-size:16px; margin-top:8px}
  th,td{border-bottom:1px solid #233044; padding:10px; text-align:center}
  th{color:#a8b3c7}
  .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  .story{line-height:1.9; font-size:18px; background:#0b1324; border:1px solid #263650; border-radius:16px; padding:14px}
  .num{font-weight:800; color:#38bdf8}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .pill{display:inline-block; border:1px solid #2a3a52; padding:4px 10px; border-radius:999px; font-size:12px; color:#cbd5e1}
  .mini{font-size:12px; color:#94a3b8}
  .big{font-size:20px}
</style>
</head>
<body>
<header>
  <h1>ã‹ã‚“ãŸã‚“ç´°èƒã‘ã„ã•ã‚“ï¼ˆè¶…ã‚„ã•ã—ã„ç‰ˆï¼‰</h1>
  <div class="mini">ã‚€ãšã‹ã—ã„è¨€è‘‰ã¬ãã€‚æ•°å­—ã‚’å…¥ã‚Œã¦ãƒœã‚¿ãƒ³ã‚’ãŠã™ã ã‘ï¼</div>
</header>
<main>

<!-- â‘  ç´°èƒã‚’æ•°ãˆãŸå›æ•° -->
<section>
  <h2>â‘  ç´°èƒã‚’æ•°ãˆãŸå›æ•°</h2>
  <div class="pill">ã¾ãšã¯æ•°ãˆãŸæ•°ã‚’å…¥ã‚Œã¦ã­ï¼ˆãƒ˜ãƒ¢ã‚µã‚¤ãƒˆãƒ¡ãƒ¼ã‚¿ãƒ¼ã®å¤§ãã„ãƒã‚¹1ã¤åˆ†ï¼‰</div>
  <table id="tbl">
    <thead><tr><th>#</th><th>ç”Ÿãã¦ã„ã‚‹ç´°èƒ</th><th>æ­»ã‚“ã§ã„ã‚‹ç´°èƒ</th><th>ãœã‚“ã¶</th></tr></thead>
    <tbody>
      <tr><td>1</td><td><input class="live" inputmode="decimal"></td><td><input class="dead" inputmode="decimal"></td><td class="total"></td></tr>
      <tr><td>2</td><td><input class="live" inputmode="decimal"></td><td><input class="dead" inputmode="decimal"></td><td class="total"></td></tr>
      <tr><td>3</td><td><input class="live" inputmode="decimal"></td><td><input class="dead" inputmode="decimal"></td><td class="total"></td></tr>
      <tr><td>4</td><td><input class="live" inputmode="decimal"></td><td><input class="dead" inputmode="decimal"></td><td class="total"></td></tr>
    </tbody>
  </table>
  <div class="btns">
    <button id="addRow">ï¼‹ è¡Œã‚’è¿½åŠ </button>
    <button id="calcCount" class="big">âœ… è¨ˆç®—ã™ã‚‹</button>
    <button id="clearCount">ã‚¯ãƒªã‚¢</button>
  </div>
  <div class="mini">â€»æ•°å­—ã¯ã€Œ1,234ã€ã¿ãŸã„ã«ã‚«ãƒ³ãƒã‚ã‚Šã§ã‚‚OKã€‚</div>
</section>

<!-- â‘¡ å…¥åŠ›ï¼ˆä½“ç©ãªã©ï¼‰ -->
<section>
  <h2>â‘¡ å…¥åŠ›ï¼ˆä½“ç©ãªã©ï¼‰</h2>
  <div class="grid">
    <div class="field"><label>è¨ˆæ•°ã§ä½¿ã£ãŸç´°èƒæ¶²ï¼ˆåŸæ¶², <b>Î¼L</b>ï¼‰</label><input id="Vorig_uL" type="number" step="any" placeholder="ä¾‹ï¼š100"></div>
    <div class="field"><label>è¨ˆæ•°ã§ä½¿ã£ãŸãƒˆãƒªãƒ‘ãƒ³ãƒ–ãƒ«ãƒ¼ï¼ˆ<b>Î¼L</b>ï¼‰</label><input id="Vtb_uL" type="number" step="any" placeholder="ä¾‹ï¼š100"></div>
    <div class="field"><label>åŸ¹é¤Šå®¹å™¨ã«å…¥ã‚Œã‚‹æ¶²é‡ï¼ˆmLï¼‰</label><input id="Vwell" type="number" step="any" placeholder="ä¾‹ï¼š10"></div>
    <div class="field"><label>å‡çµãƒãƒ¥ãƒ¼ãƒ–1æœ¬ã®ä½“ç©ï¼ˆmLãƒ»ä»»æ„ï¼‰</label><input id="Vfreeze" type="number" step="any" placeholder="ä¾‹ï¼š1"></div>
    <div class="field"><label>ç›®æ¨™ã®æ¿ƒã• Ctï¼ˆcells/mLãƒ»ä»»æ„ï¼‰</label><input id="Ct" type="number" step="any" placeholder="ä¾‹ï¼š1.0e6"></div>
    <div class="field"><label>ä½œã‚ŠãŸã„æœ€çµ‚ã®ä½“ç©ï¼ˆmLãƒ»ä»»æ„ï¼‰</label><input id="Vtarget" type="number" step="any" placeholder="ä¾‹ï¼š10"></div>
  </div>
  <div class="btns">
    <button id="calcVolumes" class="big">âœ… ä½“ç©ã¤ã‹ã£ã¦è¨ˆç®—</button>
    <button id="clearVolumes">ã‚¯ãƒªã‚¢</button>
  </div>
</section>

<!-- â‘¢ ãŠã¯ãªã—è¡¨ç¤º -->
<section>
  <h2>â‘¢ ãŠã¯ãªã—</h2>
  <div id="story" class="story">
    ã“ã“ã«çµæœãŒå‡ºã¾ã™ã€‚ä¸Šã§æ•°å­—ã‚’å…¥ã‚Œã¦ <b>âœ… è¨ˆç®—ã™ã‚‹</b> ã‚’ãŠã—ã¦ã­ã€‚
  </div>
</section>

<!-- â‘£ ã¾ã¨ã‚ï¼ˆæ•°å€¤ã ã‘ï¼‰ -->
<section>
  <h2>â‘£ ã¾ã¨ã‚ï¼ˆæ•°å€¤ï¼‰</h2>
  <div id="summary" class="story"></div>
</section>

</main>

<script>
function num(v){if(v==null||v==='') return NaN; const s=String(v).replace(/[,\\s]/g,''); const x=parseFloat(s); return isFinite(x)?x:NaN;}
function fmt(v,d=6){return isFinite(v)?Number(v).toLocaleString(undefined,{maximumSignificantDigits:d}):'';}

let last = {sumL:NaN, sumD:NaN, sumT:NaN, avgT:NaN, viab:NaN, Clive:NaN, Ctotal:NaN, DF:NaN};

document.getElementById('addRow').addEventListener('click',()=>{
  const tb=document.querySelector('#tbl tbody');
  const i=tb.querySelectorAll('tr').length+1;
  const tr=document.createElement('tr');
  tr.innerHTML = `<td>${i}</td><td><input class="live" inputmode="decimal"></td><td><input class="dead" inputmode="decimal"></td><td class="total"></td>`;
  tb.appendChild(tr);
});

// â‘  æ•°ãˆã‚‹ â†’ åˆè¨ˆãƒ»å¹³å‡ãƒ»ç”Ÿå­˜ç‡
document.getElementById('calcCount').addEventListener('click',()=>{
  const rows=[...document.querySelectorAll('#tbl tbody tr')];
  let sumL=0,sumD=0,sumT=0,n=0;
  rows.forEach(tr=>{
    const l=num(tr.querySelector('.live').value);
    const d=num(tr.querySelector('.dead').value);
    const t=(isFinite(l)?l:0)+(isFinite(d)?d:0);
    tr.querySelector('.total').textContent = fmt(t,6);
    if(isFinite(l)||isFinite(d)){ n++; if(isFinite(l)) sumL+=l; if(isFinite(d)) sumD+=d; sumT+=t; }
  });
  const avgT = n? sumT/n : NaN;
  const viab = sumT>0 ? sumL/sumT*100 : NaN;

  last.sumL=sumL; last.sumD=sumD; last.sumT=sumT; last.avgT=avgT; last.viab=viab;

  const s = document.getElementById('story');
  s.innerHTML = `ğŸ‘€ ãã¿ãŒã‹ããˆãŸ <b>ç”Ÿãã¦ã„ã‚‹ç´°èƒ</b> ã¯ <span class="num">${fmt(sumL,6)}</span> å€‹ã€<br>
  <b>æ­»ã‚“ã§ã„ã‚‹ç´°èƒ</b> ã¯ <span class="num">${fmt(sumD,6)}</span> å€‹ ã§ã—ãŸã€‚<br><br>
  ãœã‚“ã¶ã‚ã‚ã›ã‚‹ã¨ <span class="num">${fmt(sumT,6)}</span> å€‹ã€‚1å›ã‚ãŸã‚Šã®ã¸ã„ãã‚“ã¯ <span class="num">${fmt(avgT,6)}</span> å€‹ï¼<br>
  ã ã‹ã‚‰ <b>ç”Ÿãã¦ã„ã‚‹ã‚ã‚Šã‚ã„</b> ã¯ <span class="num">${isFinite(viab)?viab.toFixed(2):''}</span> % ã ã‚ˆã€‚<br>
  â¬‡ã¤ãã¯ä¸‹ã®ã€Œä½“ç©ã€ã‚’å…¥ã‚Œã¦ã€ã“ã•ï¼ˆæ¿ƒåº¦ï¼‰ã‚’å‡ºã—ã¦ã¿ã‚ˆã†ï¼`;
  updateSummary();
});

// â‘¡ ä½“ç© â†’ æ¿ƒåº¦ã‚„å¿…è¦é‡
document.getElementById('calcVolumes').addEventListener('click',()=>{
  const Vorig_uL=num(document.getElementById('Vorig_uL').value);
  const Vtb_uL=num(document.getElementById('Vtb_uL').value);
  const Vwell=num(document.getElementById('Vwell').value);
  const Vfreeze=num(document.getElementById('Vfreeze').value);
  const Ct=num(document.getElementById('Ct').value);       // ç›®æ¨™ã®æ¿ƒã•ï¼ˆä»»æ„ï¼‰
  const Vtarget=num(document.getElementById('Vtarget').value); // ä½œã‚ŠãŸã„ä½“ç©ï¼ˆä»»æ„ï¼‰

  if(!(isFinite(Vorig_uL)&&isFinite(Vtb_uL)) || Vorig_uL<=0 || Vtb_uL<0){
    alert('ã€Œç´°èƒæ¶²ï¼ˆÎ¼Lï¼‰ã€ã¨ã€Œãƒˆãƒªãƒ‘ãƒ³ãƒ–ãƒ«ãƒ¼ï¼ˆÎ¼Lï¼‰ã€ã‚’å…¥ã‚Œã¦ã­ã€‚'); return;
  }

  // è¨ˆæ•°æ™‚ã®å¸Œé‡ˆå€ç‡ï¼ˆÎ¼Lã®ã¾ã¾ã§OKï¼šå˜ä½ã¯æ¶ˆãˆã‚‹ï¼‰
  const DF = (Vorig_uL + Vtb_uL) / Vorig_uL;
  last.DF = DF;

  // ãƒ˜ãƒ¢ã‚µã‚¤ãƒˆãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼š1å¤§åŒºç”»=1e-4 mL â†’ Ã—10^4
  const avgL = isFinite(last.sumL) && isFinite(last.sumT) ? (last.sumL / Math.max(1,(last.sumL||0 || last.sumT||0))) : NaN; // not used
  const avgPerSquare = isFinite(last.avgT) ? last.avgT : NaN;
  const avgLivePerSquare = isFinite(last.sumL) && isFinite(last.avgT) ? (last.sumL / (last.sumT>0 ? (last.sumT/last.avgT):NaN)) : NaN;

  // ã‚ˆã‚Šå®‰å®šï¼šè¡Œã”ã¨ã®å¹³å‡ã‚’å†è¨ˆç®—
  const rows=[...document.querySelectorAll('#tbl tbody tr')];
  let liveSum=0,totalSum=0,counted=0;
  rows.forEach(tr=>{
    const l=num(tr.querySelector('.live').value);
    const d=num(tr.querySelector('.dead').value);
    if(isFinite(l)||isFinite(d)){ counted++; liveSum+= (isFinite(l)?l:0); totalSum+= (isFinite(l)?l:0) + (isFinite(d)?d:0); }
  });
  const liveAvg = counted? liveSum/counted : NaN;
  const totalAvg = counted? totalSum/counted : NaN;

  const Clive = isFinite(liveAvg) ? liveAvg * 1e4 * DF : NaN;   // ç”Ÿç´°èƒã®æ¿ƒã•ï¼ˆcells/mLï¼‰
  const Ctotal = isFinite(totalAvg)? totalAvg* 1e4 * DF : NaN;  // å…¨ç´°èƒã®ã“ã•

  last.Clive = Clive; last.Ctotal = Ctotal;

  // å‡çµãƒãƒ¥ãƒ¼ãƒ–ã®å…¨ç´°èƒï¼ˆæœªå…¥åŠ›ã¯1 mLï¼‰
  const vF = isFinite(Vfreeze)? Vfreeze : 1;
  const cellsPerTube = isFinite(Ctotal)? Ctotal * vF : NaN;

  // åŸ¹é¤Šå®¹å™¨ã®ç”Ÿç´°èƒ
  const cellsInVessel = (isFinite(Clive)&&isFinite(Vwell)) ? Clive * Vwell : NaN;

  // ç›®æ¨™ã®æ¿ƒã•ã¨ä½“ç©ã‹ã‚‰ã€å¿…è¦ãªç´°èƒæ¶²é‡ã¨åŸ¹åœ°é‡
  let Vs_needed=NaN, Vmed_needed=NaN, targetConc=NaN, guide='';
  if (isFinite(Ct) && isFinite(Vtarget) && isFinite(Clive) && Vtarget>0){
    targetConc = Ct;
    Vs_needed = Vtarget * (Ct/Clive);
    Vmed_needed = Vtarget - Vs_needed;
    if (Vmed_needed < 0){
      guide = 'ï¼ˆâ€» ç›®æ¨™ãŒã“ã™ãã‚‹ã®ã§ã€ã¾ãšæ¿ƒç¸®ã—ã¦ã­ï¼‰';
      Vmed_needed = 0;
    }
  }

  // ãŠã¯ãªã—ã‚’ã‚„ã•ã—ãè¡¨ç¤º
  const s = document.getElementById('story');
  s.innerHTML += `<br><br>ğŸ§ª ä½“ç©ã‹ã‚‰ã“ã•ï¼ˆæ¿ƒåº¦ï¼‰ã‚’å‡ºã—ãŸã‚ˆã€‚<br>
  ãƒ»ç”Ÿãã¦ã„ã‚‹ç´°èƒã®ã“ã•ã¯ <span class="num">${fmt(Clive,6)}</span> cells/mL<br>
  ãƒ»ãœã‚“ã¶ã®ç´°èƒã®ã“ã•ã¯ <span class="num">${fmt(Ctotal,6)}</span> cells/mL<br>
  ãƒ»å‡çµãƒãƒ¥ãƒ¼ãƒ–ï¼ˆ<span class="num">${fmt(vF,6)}</span> mLï¼‰ã«ã¯ <span class="num">${fmt(cellsPerTube,6)}</span> å€‹ã¯ã„ã‚Šã¾ã™<br>
  ãƒ»åŸ¹é¤Šå®¹å™¨ï¼ˆ<span class="num">${fmt(Vwell,6)}</span> mLï¼‰ã«å…¥ã‚‹ç”Ÿãã¦ã„ã‚‹ç´°èƒã¯ <span class="num">${fmt(cellsInVessel,6)}</span> å€‹ã ã‚ˆ<br>
  ãƒ»ï¼ˆè¨ˆæ•°ã®ã¨ãã®ã†ã™ã‚ãŸå€ç‡ï¼<span class="num">${fmt(DF,6)}</span>å€ï¼‰`;

  if (isFinite(Vs_needed) && isFinite(Vmed_needed)){
    s.innerHTML += `<br><br>ğŸ¯ ç›®çš„ã®ã“ã• <span class="num">${fmt(targetConc,6)}</span> cells/mL ã®
    <span class="num">${fmt(Vtarget,6)}</span> mL ã‚’ã¤ãã‚‹ã«ã¯â€¦<br>
    ğŸ‘‰ ç´°èƒæ¶²ï¼ˆåŸæ¶²ï¼‰<span class="num">${fmt(Vs_needed,6)}</span> mL ã¨ã€åŸ¹åœ° <span class="num">${fmt(Vmed_needed,6)}</span> mL ã‚’ã¾ãœã‚ˆã†ï¼ ${guide}`;
  }

  updateSummary();
});

// ã‚¯ãƒªã‚¢
document.getElementById('clearCount').addEventListener('click',()=>{
  document.querySelectorAll('#tbl input').forEach(i=>i.value='');
  document.querySelectorAll('#tbl .total').forEach(td=>td.textContent='');
  Object.keys(last).forEach(k=>last[k]=NaN);
  document.getElementById('story').innerHTML='ã“ã“ã«çµæœãŒå‡ºã¾ã™ã€‚ä¸Šã§æ•°å­—ã‚’å…¥ã‚Œã¦ <b>âœ… è¨ˆç®—ã™ã‚‹</b> ã‚’ãŠã—ã¦ã­ã€‚';
  updateSummary();
});
document.getElementById('clearVolumes').addEventListener('click',()=>{
  ['Vorig_uL','Vtb_uL','Vwell','Vfreeze','Ct','Vtarget'].forEach(id=>document.getElementById(id).value='');
  updateSummary();
});

// â‘£ ã¾ã¨ã‚ï¼ˆæ•°å€¤ï¼‰
function updateSummary(){
  const box = document.getElementById('summary');
  const lines = [];
  lines.push(`ç”Ÿãã¦ã„ã‚‹ç´°èƒ åˆè¨ˆ: <b>${fmt(last.sumL,6)}</b> å€‹`);
  lines.push(`æ­»ã‚“ã§ã„ã‚‹ç´°èƒ åˆè¨ˆ: <b>${fmt(last.sumD,6)}</b> å€‹`);
  lines.push(`ãœã‚“ã¶ã®ç´°èƒ åˆè¨ˆ: <b>${fmt(last.sumT,6)}</b> å€‹`);
  lines.push(`ãœã‚“ã¶ã®ç´°èƒ å¹³å‡: <b>${fmt(last.avgT,6)}</b> å€‹/å›`);
  lines.push(`ç”Ÿãã¦ã„ã‚‹ã‚ã‚Šã‚ã„: <b>${isFinite(last.viab)?last.viab.toFixed(2):''}</b> %`);
  if (isFinite(last.Clive)) lines.push(`ç”Ÿç´°èƒã®ã“ã•: <b>${fmt(last.Clive,6)}</b> cells/mL`);
  if (isFinite(last.Ctotal)) lines.push(`å…¨ç´°èƒã®ã“ã•: <b>${fmt(last.Ctotal,6)}</b> cells/mL`);
  if (isFinite(last.DF)) lines.push(`ï¼ˆè¨ˆæ•°æ™‚ã®ã†ã™ã‚ãŸå€ç‡: ${fmt(last.DF,6)} å€ï¼‰`);
  box.innerHTML = lines.join('<br>');
}
</script>
</body>
</html>
