<script>
/* === 倍化（週プラン）：曜日ベース／日付なし === */
(function(){
  const WN = ['月','火','水','木','金','土','日'];

  function fmtSciHTML(x, d=2){
    if(!Number.isFinite(x) || x===0) return Number.isFinite(x)?'0':'—';
    const s = x<0?'-':'';
    const ax = Math.abs(x);
    const e = Math.floor(Math.log10(ax));
    const m = ax / Math.pow(10, e);
    return `${s}${m.toFixed(d)}×10<sup>${e}</sup>`;
  }
  function ymd(d){ return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function mondayOf(d){
    const x=new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = (x.getDay()+6)%7; // 0=Mon ... 6=Sun
    x.setDate(x.getDate()-day);
    return x;
  }
  function getMode(){ return (document.querySelector('input[name="dbw_mode"]:checked')?.value)||'DT'; }
  function gPerDay(){
    const mode=getMode();
    const DT = Number(document.getElementById('dbw_DT')?.value)||24;
    const fold = Number(document.getElementById('dbw_fold')?.value)||2;
    return mode==='FOLD' ? (fold>0?fold:2) : Math.pow(2, 24/(DT>0?DT:24));
  }

  // --- 保存/復元 ---
  function save(){
    const data = {
      start:  document.getElementById('dbw_start')?.value||'',
      C0:     document.getElementById('dbw_C0')?.value||'',
      mode:   getMode(),
      DT:     document.getElementById('dbw_DT')?.value||'',
      fold:   document.getElementById('dbw_fold')?.value||'',
      passDay:document.getElementById('dbw_passDay')?.value||'2',
      expDay: document.getElementById('dbw_expDay')?.value||'4',
      targetC:document.getElementById('dbw_targetC')?.value||'1e6',
    };
    localStorage.setItem('dbw_inputs', JSON.stringify(data));
  }
  function load(){
    const raw = localStorage.getItem('dbw_inputs');
    if(!raw) return;
    try{
      const d=JSON.parse(raw);
      if(d.start)   document.getElementById('dbw_start').value = d.start;
      if(d.C0)      document.getElementById('dbw_C0').value = d.C0;
      if(d.mode){
        const r = document.querySelector(`input[name="dbw_mode"][value="${d.mode}"]`);
        if(r) r.checked = true;
      }
      if(d.DT)      document.getElementById('dbw_DT').value = d.DT;
      if(d.fold)    document.getElementById('dbw_fold').value = d.fold;
      if(d.passDay) document.getElementById('dbw_passDay').value = d.passDay;
      if(d.expDay)  document.getElementById('dbw_expDay').value = d.expDay;
      if(d.targetC) document.getElementById('dbw_targetC').value = d.targetC;
    }catch(e){}
  }

  // --- 週間計画（曜日だけで運用） ---
  function planWeek(){
    const tableEl = document.getElementById('dbw_table');
    if(!tableEl) return;

    // 入力
    let start = document.getElementById('dbw_start')?.value;
    if(!start){
      const mon = mondayOf(new Date());
      document.getElementById('dbw_start').value = ymd(mon);
      start = ymd(mon);
    }
    const startDate = new Date(start+'T00:00:00');
    let C = Number(document.getElementById('dbw_C0')?.value)||0;     // 週の開始日の朝の濃度
    const passDay = Number(document.getElementById('dbw_passDay')?.value)||2; // 0=月
    const expDay  = Number(document.getElementById('dbw_expDay')?.value)||4;  // 0=月（金デフォ）
    const targetC = Number(document.getElementById('dbw_targetC')?.value)||0;
    const g = gPerDay();

    // 表構築
    const rows = [];
    for(let d=0; d<7; d++){
      const date = addDays(startDate, d);
      let op=''; let fText=''; let Cafter='—';

      // 継代日に、実験曜日の“朝”に目標濃度へ到達するよう逆算した希釈倍率を提案
      if(d===passDay && targetC>0){
        const daysToExp = (expDay - d + 7) % 7;              // 継代→実験日の朝までの日数
        const neededAfter = targetC / Math.pow(g, daysToExp); // 継代直後に必要な濃度
        if(neededAfter>0){
          const f = C>0 ? (C / neededAfter) : NaN;
          if(Number.isFinite(f) && f>0){
            if(f>=1){ op='希釈'; fText = `1:${f.toFixed(2)}`; }
            else    { op='濃縮'; fText = `× ${(1/f).toFixed(2)}`; }
            C = neededAfter;                     // 希釈後を起点に再増殖
            Cafter = `${C.toLocaleString()}（= ${fmtSciHTML(C)}）`;
          }
        }
      }

      const Cstart = C;           // 朝の濃度
      const Cend   = Cstart * g;  // 当日終わり（1日分の増殖）
      C = Cend;                   // 次日朝へ引き継ぎ

      rows.push({
        '曜日': WN[d],
        '日付': ymd(date),
        '朝の濃度': `${Cstart.toLocaleString()}（= ${fmtSciHTML(Cstart)}）`,
        '操作': op || '',
        '推奨希釈': fText || '',
        '希釈後の濃度': Cafter,
        '当日終わりの濃度': `${Cend.toLocaleString()}（= ${fmtSciHTML(Cend)}）`,
      });
    }

    // 描画
    let html='<table><thead><tr>';
    const keys = Object.keys(rows[0]||{'—':'—'});
    keys.forEach(k=> html+=`<th>${k}</th>`); html+='</tr></thead><tbody>';
    html += rows.map(r=>'<tr>'+keys.map(k=>`<td>${r[k]??''}</td>`).join('')+'</tr>').join('');
    html+='</tbody></table>';
    tableEl.innerHTML=html;
  }

  // --- 自動計算/保存の配線 ---
  function wire(){
    const ids = ['dbw_start','dbw_C0','dbw_DT','dbw_fold','dbw_passDay','dbw_expDay','dbw_targetC'];
    ids.forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', ()=>{ save(); planWeek(); });
      el.addEventListener('change', ()=>{ save(); planWeek(); });
    });
    document.querySelectorAll('input[name="dbw_mode"]').forEach(r=>{
      r.addEventListener('change', ()=>{ save(); planWeek(); });
    });
  }

  // --- 起動 ---
  window.addEventListener('load', ()=>{
    // 旧フォーマット掃除（expDateが残っていたら削除）
    try{ const d=JSON.parse(localStorage.getItem('dbw_inputs')||'{}'); if('expDate' in d){ delete d.expDate; localStorage.setItem('dbw_inputs', JSON.stringify(d)); } }catch(e){}
    // 週開始日のデフォルト（月曜日）
    const startEl = document.getElementById('dbw_start');
    if(startEl && !startEl.value){ startEl.value = ymd(mondayOf(new Date())); }
    load();
    wire();
    planWeek();
  });
})();
</script>

