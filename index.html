import React, { useMemo, useState } from "react";

const toLocalYMD = (d) => { const y = d.getFullYear(); const m = String(d.getMonth() + 1).padStart(2, "0"); const day = String(d.getDate()).padStart(2, "0"); return `${y}-${m}-${day}`; };
const parseLocalDate = (s) => { const [y, m, d] = s.split("-").map(Number); if (!y || !m || !d) return NaN; return new Date(y, m - 1, d).getTime(); };
const fmtSci = (n) => { if (!Number.isFinite(n)) return "—"; if (n === 0) return "0"; const a = Math.abs(n); if (a >= 1e5 || a < 1e-2) { const exp = Math.floor(Math.log10(a)); const mant = n / Math.pow(10, exp); return `${Math.round(mant * 100) / 100}×10^${exp}`; } return (Math.round(n * 1000) / 1000).toString(); };

function CalendarCultureScheduler() {
  const today = toLocalYMD(new Date());
  const [doublingH, setDoublingH] = useState("12");
  const [c0, setC0] = useState("1e5");
  const [neededCells, setNeededCells] = useState("1e5");
  const [neededVol, setNeededVol] = useState("1");

  const [startDate, setStartDate] = useState(today);
  const [expDate, setExpDate] = useState(toLocalYMD(new Date(Date.now() + 7*24*3600*1000)));
  const [passages, setPassages] = useState([{ date: toLocalYMD(new Date(Date.now() + 3*24*3600*1000)), df: "20" }]);

  const addPassage = () => setPassages((prev) => [...prev, { date: today, df: "2" }]);
  const updatePassageDate = (i, v) => setPassages((prev) => prev.map((p, idx) => idx === i ? { ...p, date: v } : p));
  const updatePassageDF = (i, v) => setPassages((prev) => prev.map((p, idx) => idx === i ? { ...p, df: v } : p));
  const removePassage = (i) => setPassages((prev) => prev.filter((_, idx) => idx !== i));

  const Td = Number(doublingH);
  const C0 = Number(c0);
  const targetCells = Number(neededCells);
  const targetVol = Number(neededVol);
  const targetConc = targetCells / Math.max(1e-9, targetVol);

  const startTs = parseLocalDate(startDate);
  const expTs = parseLocalDate(expDate);
  const days = Number.isFinite(startTs) && Number.isFinite(expTs) ? Math.max(0, Math.round((expTs - startTs) / (24*3600*1000))) : 0;
  const dailyFactor = Td > 0 ? Math.pow(2, 24 / Td) : NaN;

  const dfByDate = passages.reduce((acc, p) => {
    if (!p.date) return acc;
    const df = parseFloat(p.df);
    if (!Number.isFinite(df) || df <= 0) return acc;
    acc[p.date] = (acc[p.date] || 1) * df;
    return acc;
  }, {});

  let current = C0;
  const rows = [];
  for (let k = 0; k <= days; k++) {
    const d = new Date(startTs + k * 24*3600*1000);
    const ymd = toLocalYMD(d);
    if (k === 0) {
      // initial as-is
    } else {
      current = Number.isFinite(dailyFactor) ? current * dailyFactor : NaN;
    }
    const before = current;
    let after = undefined;
    const df = dfByDate[ymd];
    if (Number.isFinite(before) && Number.isFinite(df)) {
      after = before / df;
      current = after; // carry forward post-dilution
    }
    rows.push({ date: ymd, before, df, after });
  }

  return (
    <div className="space-y-4">
      <h2 className="text-lg font-semibold">細胞培養計画スケジューラ</h2>

      <div className="grid md:grid-cols-3 gap-3">
        <label className="flex flex-col text-sm"><span>開始日</span><input type="date" value={startDate} onChange={(e)=>setStartDate(e.target.value)} /></label>
        <label className="flex flex-col text-sm"><span>実験日</span><input type="date" value={expDate} onChange={(e)=>setExpDate(e.target.value)} /></label>
        <div className="flex flex-col text-sm gap-1">
          <span>継代日</span>
          {passages.map((p,i)=> (
            <div key={i} className="flex items-center gap-2">
              <input type="date" value={p.date} onChange={(e)=>updatePassageDate(i, e.target.value)} />
              <span>希釈</span>
              <input type="number" step="0.1" className="border rounded p-1 w-24 text-right" value={p.df} onChange={(e)=>updatePassageDF(i, e.target.value)} />
              <span>倍</span>
              <button onClick={()=>removePassage(i)} className="text-red-600">削除</button>
            </div>
          ))}
          <button onClick={addPassage} className="bg-emerald-500 text-white rounded px-2 py-1 text-sm">＋追加</button>
        </div>
      </div>

      <div className="grid md:grid-cols-4 gap-3">
        <label className="flex flex-col text-sm"><span>倍加時間 (h)</span><input type="number" value={doublingH} onChange={(e)=>setDoublingH(e.target.value)} /></label>
        <label className="flex flex-col text-sm"><span>開始濃度 C0 (cells/mL)</span><input type="number" value={c0} onChange={(e)=>setC0(e.target.value)} /></label>
        <label className="flex flex-col text-sm"><span>実験に必要な細胞濃度 (cells/mL)</span><input type="number" value={neededCells} onChange={(e)=>setNeededCells(e.target.value)} /></label>
        <label className="flex flex-col text-sm"><span>実験に必要な液量 (mL)</span><input type="number" value={neededVol} onChange={(e)=>setNeededVol(e.target.value)} /></label>
      </div>

      <table className="min-w-full text-sm border border-slate-200 bg-white">
        <thead className="bg-slate-50">
          <tr>
            <th className="px-2 py-1 text-left">日にち</th>
            <th className="px-2 py-1 text-left">細胞濃度（前）</th>
            <th className="px-2 py-1 text-left">希釈</th>
            <th className="px-2 py-1 text-left">細胞濃度（後）</th>
          </tr>
        </thead>
        <tbody>
          {rows.map((r, i) => (
            <tr key={i} className="border-t">
              <td className="px-2 py-1">{r.date}</td>
              <td className="px-2 py-1">{fmtSci(r.before)} cells/mL</td>
              <td className="px-2 py-1">{Number.isFinite(r.df) ? `${r.df}倍希釈` : ""}</td>
              <td className="px-2 py-1">{Number.isFinite(r.after) ? `${fmtSci(r.after)} cells/mL` : ""}</td>
            </tr>
          ))}
        </tbody>
      </table>

      <div className="rounded border p-3 bg-white text-xs space-y-1">
        <div>1日あたりの増殖率: {Number.isFinite(dailyFactor) ? `${(Math.round(dailyFactor*100)/100)}×` : "—"}</div>
        <div>目標濃度: {fmtSci(targetConc)} cells/mL</div>
        <div className="text-slate-600">※ 希釈はその日の行内で実施し、翌日の増殖は希釈後濃度を基準に計算します。</div>
      </div>
    </div>
  );
}

export default CalendarCultureScheduler;
