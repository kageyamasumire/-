<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>だれでもわかる 細胞培養 計画・手順アプリ v0.9</title>
<style>
  :root{ --panel-width: 980px; --panel-bg:#fff; --panel-border:#e6e6e6; --accent:#2f54eb; --muted:#666; }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif; background:#f7f8fa; color:#111; }
  .wrap{ max-width: var(--panel-width); margin: 24px auto; padding: 16px; }
  h1{ margin:0 0 8px; font-size:22px }
  .desc{ color:var(--muted); margin:0 0 16px }
  .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px }
  .tab-btn{ padding:8px 12px; border:1px solid #d9d9d9; border-radius:10px; background:#fff; cursor:pointer; transition:.15s }
  .tab-btn.active{ background:#f0f5ff; border-color:#adc6ff }
  .panel{ border:1px solid var(--panel-border); background:#fff; border-radius:12px; padding:14px }
  .card{ border:1px solid var(--panel-border); border-radius:12px; background:#fff; padding:14px; margin-bottom:12px }
  .card h3{ margin:0 0 8px; font-size:16px }
  .field{ display:grid; grid-template-columns:230px 1fr; gap:8px; align-items:center; margin-bottom:8px }
  .field input[type=number], .field input[type=text], .field input[type=date], .field select{ width:230px; padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#fff; text-align:right }
  .field input[type=text]{ text-align:left }
  .suffix{ color:#666; font-size:12px; margin-left:6px }
  .note{ font-size:12px; color:#666 }
  .warn{ margin-top:8px; padding:8px; background:#fff7e6; border:1px solid #ffe7ba; color:#ad4e00; border-radius:8px }
  .danger{ margin-top:8px; padding:8px; background:#fff1f0; border:1px solid #ffccc7; color:#a8071a; border-radius:8px }
  .row{ display:grid; grid-template-columns:1fr auto; gap:8px; padding:6px 0; border-bottom:1px dotted #eee }
  .row:last-child{ border-bottom:0 }
  .value{ font-variant-numeric: tabular-nums; white-space:nowrap }
  .btn{ display:inline-block; background:#fff; border:1px solid #d9d9d9; border-radius:10px; padding:8px 12px; cursor:pointer; transition:.15s }
  .btn:hover{ border-color:#bfbfbf }
  .btn-ghost{ background:#fff; color:#2f54eb; border-color:#adc6ff }
  textarea{ width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; font-family:inherit }
  table{ width:100%; border-collapse:collapse; font-size:12px }
  th,td{ border-bottom:1px solid #f0f0f0; text-align:left; padding:6px 4px; vertical-align:top }
  th{ color:#555; font-weight:600; background:#fafafa }
  @media (max-width:720px){
    .field{ grid-template-columns:1fr }
    .field input,.field select{ width:100% }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>だれでもわかる 細胞培養 計画・手順アプリ <span class="note">v0.9</span></h1>
  <p class="desc">初心者向けに「やさしい表示＋くわしい式の補足」を同時に表示します。全入力はブラウザに保存されます（同一ブラウザ限定）。</p>

  <div class="tabs">
    <button class="tab-btn active" data-tab="cells">細胞数 / 生存率</button>
    <button class="tab-btn" data-tab="doubling">細胞倍加（週プラン）</button>
    <button class="tab-btn" data-tab="reagents">試薬の調整（細胞培養）</button>
    <button class="tab-btn" data-tab="sterile">滅菌方法（器具/試薬）</button>
    <button class="tab-btn" data-tab="culture">細胞培養（SOP）</button>
    <button class="tab-btn" data-tab="passage">細胞継代（付着型/浮遊型）</button>
    <button class="tab-btn" data-tab="thaw">凍結細胞の解凍</button>
    <button class="tab-btn" data-tab="freeze">凍結保存</button>
    <button class="tab-btn" data-tab="recipes">ストック溶液レシピ</button>
    <button class="tab-btn" data-tab="vessels">培養容器データ集</button>
    <button class="tab-btn" data-tab="units">単位換算</button>
  </div>

  <div class="panel">
    <!-- ======================= Cells ======================= -->
    <section id="tab-cells">
      <div class="card">
        <h3>入力（打つたび自動計算 & 保存）</h3>
        <div class="field"><div>マス数</div><div><input type="number" id="squares" value="4" step="1"></div></div>
        <div class="field"><div>生細胞数の合計（自分で記入）</div><div><input type="number" id="liveTotal" step="1"></div></div>
        <div class="field"><div>死細胞数の合計（自分で記入）</div><div><input type="number" id="deadTotal" step="1"></div></div>
        <div class="field"><div>1マス体積（計算は 10<sup>4</sup> 固定）</div><div><input type="number" value="0.0001" readonly><span class="suffix">mL</span></div></div>
        <div class="field"><div>細胞液量（原液）</div><div><input type="number" id="stockVol"><span class="suffix">µL</span></div></div>
        <div class="field"><div>トリパンブルー溶液量</div><div><input type="number" id="tbVol"><span class="suffix">µL</span></div></div>
        <div class="field"><div>凍結チューブ体積</div><div><input type="number" id="frozenVol" value="2"><span class="suffix">mL</span></div></div>
        <div class="field"><div>培養容器内の液量</div><div><input type="number" id="containerVol"><span class="suffix">mL</span></div></div>
        <div class="field"><div>継代後の細胞濃度（目標）</div><div><input type="number" id="targetConc" step="1000"><span class="suffix">cells/mL</span></div></div>
        <div class="note">※ 生細胞濃度 = 生平均 × 希釈倍率 × 10<sup>4</sup> /mL（血球計算盤）</div>
      </div>

      <div class="card">
        <h3>計算結果（やさしい表示 / くわしい式）</h3>
        <div class="row"><div>生細胞数の合計</div><div class="value" id="r_liveSum">—</div></div>
        <div class="row"><div>生細胞数の平均</div><div class="value" id="r_liveAvg">—</div></div>
        <div class="row"><div>死細胞数の合計</div><div class="value" id="r_deadSum">—</div></div>
        <div class="row"><div>死細胞数の平均</div><div class="value" id="r_deadAvg">—</div></div>
        <div class="row"><div>全細胞数の合計</div><div class="value" id="r_totalSum">—</div></div>
        <div class="row"><div>全細胞数の平均</div><div class="value" id="r_totalAvg">—</div></div>
        <div class="row"><div>必要液量（細胞液 + トリパンブルー）</div><div class="value" id="r_totalMix">— µL</div></div>
        <div class="row"><div>希釈倍率（必要液量 ÷ 細胞液量）</div><div class="value" id="r_DF">—</div></div>
        <div class="row"><div>生存率（生平均 ÷ 全平均 × 100）</div><div class="value" id="r_viab">— %</div></div>
        <div class="row"><div>生細胞濃度（生平均 × DF × 10<sup>4</sup>）</div><div class="value" id="r_liveConc">— cells/mL</div></div>
        <div class="row"><div>全細胞濃度（全平均 × DF × 10<sup>4</sup>）</div><div class="value" id="r_totalConc">— cells/mL</div></div>
        <div class="row"><div>凍結チューブ中の全細胞数（体積[mL] × 全細胞濃度）</div><div class="value" id="r_frozen">— cells</div></div>
        <div class="row"><div>培養容器内の生細胞数（生細胞濃度 × 容器液量[mL]）</div><div class="value" id="r_container">— cells</div></div>
        <div class="row"><div>継代培養に必要な細胞液量（目標濃度 ÷ 生細胞濃度 × 容器液量）</div><div class="value" id="r_needCellVol">— mL</div></div>
        <div class="row"><div>継代培養に必要な培地（容器液量 − 必要細胞液量）</div><div class="value" id="r_needMedia">— mL</div></div>
        <div id="cellsWarn" class="warn" style="display:none;">目標濃度が高すぎる可能性：必要な細胞液量が容器液量を超えています。条件を見直してください。</div>
        <div class="note" id="cellsExplain"></div>
      </div>
    </section>

    <!-- ======================= Doubling ======================= -->
    <section id="tab-doubling" style="display:none;">
      <div class="card">
        <h3>週プラン入力（打つたび自動計算＆保存）</h3>
        <div class="field"><div>週の開始日</div><div><input type="date" id="dbw_start"><span class="suffix">未入力なら今週の月曜</span></div></div>
        <div class="field"><div>週の開始日の朝の濃度 C0</div><div><input type="number" id="dbw_C0" placeholder="例: 1e5"><span class="suffix">cells/mL</span></div></div>
        <div class="field"><div>倍化時間 DT</div><div><input type="number" id="dbw_DTh" step="0.1" placeholder="例: 12"><span class="suffix">時間/倍</span></div></div>
        <div class="field"><div>継代する曜日</div><div><select id="dbw_passDay"><option value="0">月</option><option value="1">火</option><option value="2" selected>水</option><option value="3">木</option><option value="4">金</option><option value="5">土</option><option value="6">日</option></select></div></div>
        <div class="field"><div>実験する曜日</div><div><select id="dbw_expDay"><option value="0">月</option><option value="1">火</option><option value="2">水</option><option value="3">木</option><option value="4" selected>金</option><option value="5">土</option><option value="6">日</option></select></div></div>
        <div class="field"><div>実験日の目標</div>
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <label><input type="radio" name="dbw_goal" value="conc" checked> 濃度（基本）</label>
            <input type="number" id="dbw_targetC" placeholder="例: 1e6"><span class="suffix">cells/mL</span>
            <span class="suffix">／または</span>
            <label><input type="radio" name="dbw_goal" value="cells"> 総細胞数</label>
            <input type="number" id="dbw_targetCells" placeholder="例: 1e7"><span class="suffix">cells</span>
            <span class="suffix">（この体積で確保したい →）</span>
            <input type="number" id="dbw_useVol" placeholder="例: 10"><span class="suffix">mL（任意）</span>
          </div>
        </div>
        <div class="note">※ 1日あたりの成長倍率 = 2^(24/DT)。継代日の朝に「◯倍希釈（1:◯）」を提案し、実験日朝に目標へ届くよう自動調整します。</div>
      </div>

      <div class="card">
        <h3>1週間プラン（朝 → 操作 → 当日終わり）</h3>
        <div id="dbw_table" class="note">入力してください。</div>
        <div class="note" style="margin-top:8px;">表示例：12,345（= 1.234×10<sup>4</sup>）／「20倍希釈」は 1:20 の意味です。</div>
      </div>

      <div class="card">
        <h3>実験日のサマリ</h3>
        <div class="row"><div>実験日の朝の予測濃度</div><div class="value" id="dbw_sum_Cexp">—</div></div>
        <div class="row"><div>入力：必要な濃度（基本）</div><div class="value" id="dbw_sum_targetC">—</div></div>
        <div class="row"><div>入力：必要な総細胞数（任意）</div><div class="value" id="dbw_sum_needN">—</div></div>
        <div class="row"><div>必要体積（N ÷ 予測濃度）</div><div class="value" id="dbw_sum_Vneed">—</div></div>
        <div id="dbw_warn" class="warn" style="display:none;">指定体積では細胞数が不足します。体積を増やすか、継代日の希釈倍率を調整してください。</div>
      </div>
    </section>

    <!-- ======================= Reagents ======================= -->
    <section id="tab-reagents" style="display:none;">
      <div class="card">
        <h3>プリセット</h3>
        <div class="field"><div>項目</div><div>
          <select id="reagPreset">
            <option value="mem">MEM培地</option>
            <option value="rpmi">RPMI1640培地</option>
            <option value="nahco3_10">10% NaHCO₃</option>
            <option value="gln_3">3% グルタミン</option>
            <option value="strep_100mg">100 mg/mL ストレプトマイシン</option>
            <option value="pen_100k">100,000 U/mL ペニシリン</option>
            <option value="tb_0_4">0.4% トリパンブルー</option>
            <option value="pbs1x">1× PBS(-)</option>
          </select>
        </div></div>
        <div id="reagGuide" class="note">選ぶと手順メモと既定値が入ります。</div>
      </div>

      <div class="card">
        <h3>目的体積（共通）</h3>
        <div class="field"><div>最終体積 V2</div><div><input type="number" id="V2" value="100"><span class="suffix">mL</span></div></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn" onclick="setV2(100)">100 mL</button><button class="btn" onclick="setV2(500)">500 mL</button><button class="btn" onclick="setV2(1000)">1 L</button></div>
      </div>

      <div class="card">
        <h3>% w/v → 質量</h3>
        <div class="field"><div>濃度</div><div><input type="number" id="pct" step="0.01"><span class="suffix">% w/v</span></div></div>
        <div class="row"><div>必要質量</div><div class="value" id="r_grams">— g（定容で — mL）</div></div>
        <div class="note">式：g = (%/100) × V2[mL]</div>
      </div>

      <div class="card">
        <h3>C1V1＝C2V2</h3>
        <div class="field"><div>C1（原液）</div><div><input type="number" id="C1" step="0.0001"><span id="unitC" class="suffix">mg/mL</span></div></div>
        <div class="field"><div>C2（最終）</div><div><input type="number" id="C2" step="0.0001"><span id="unitC2" class="suffix">（同上）</span></div></div>
        <div class="row"><div>必要な V1</div><div class="value" id="r_v1">— mL</div></div>
        <div class="row"><div>希釈溶媒（V2−V1）</div><div class="value" id="r_dil">— mL</div></div>
        <div id="reagWarn" class="warn" style="display:none;">入力不足/不整合です。</div>
      </div>

      <div class="card">
        <h3>X倍ストック → 最終</h3>
        <div class="field"><div>ストック倍率</div><div><input type="number" id="stockFactor" value="10"><span class="suffix">×</span></div></div>
        <div class="field"><div>最終倍率</div><div><input type="number" id="finalFactor" value="1"><span class="suffix">×</span></div></div>
        <div class="row"><div>必要ストック量</div><div class="value" id="r_fx_v1">— mL</div></div>
        <div class="row"><div>希釈溶媒</div><div class="value" id="r_fx_dil">— mL</div></div>
      </div>

      <div class="card">
        <h3>表（レシピメモ）</h3>
        <div id="reagTable" class="note">読み込み中…</div>
      </div>
    </section>

    <!-- ======================= Sterile ======================= -->
    <section id="tab-sterile" style="display:none;">
      <div class="card">
        <h3>器具/試薬から滅菌方法を検索</h3>
        <div class="field"><div>対象物</div><div><select id="sterileCatalog"></select></div></div>
        <div class="field"><div>オプション（任意）</div><div><label><input type="checkbox" id="optHasLiquid"> 液体を含む/液体の滅菌</label></div></div>
        <div id="sterileSuggest" class="note">対象物を選ぶと推奨方法が表示されます。</div>
      </div>

      <div class="card"><h3>SOP / 参考リンク</h3>
        <div class="field"><div>URLまたはメモ</div><div><input type="text" id="sterileSOP" placeholder="例: ラボSOPの場所"></div></div>
        <div class="note">具体条件は所属ラボのSOPに従ってください。</div>
      </div>

      <div class="card">
        <h3>記録フォーム</h3>
        <div class="field"><div>器材名</div><div><input type="text" id="sterileItem"></div></div>
        <div class="field"><div>方法</div><div><select id="sterileMethod"><option>オートクレーブ</option><option>乾熱</option><option>ろ過</option><option>化学</option><option>UV</option><option>炎焼却</option><option>市販滅菌品</option></select></div></div>
        <div class="field"><div>担当</div><div><input type="text" id="sterileWho"></div></div>
        <div class="field"><div>日付</div><div><input type="date" id="sterileDate"></div></div>
        <div class="field"><div>メモ</div><div><input type="text" id="sterileNote" placeholder="SOP IDなど"></div></div>
        <div style="display:flex;gap:8px;"><button class="btn" onclick="sterileAdd()">追加</button><button class="btn" onclick="sterileExport()">CSVエクスポート</button></div>
      </div>
      <div class="card"><h3>記録一覧</h3><div id="sterileTable" class="note">まだ記録がありません。</div></div>
    </section>

    <!-- ======================= Culture SOP ======================= -->
    <section id="tab-culture" style="display:none;">
      <div class="card"><h3>SOP / 参考リンク</h3>
        <div class="field"><div>URLまたはメモ</div><div><input type="text" id="cultSOP" placeholder="例: 播種/培養 SOP"></div></div>
        <div class="note">手順は高レベルの目安です。具体条件は所属ラボのSOPを最優先してください。</div>
      </div>
      <div class="card">
        <h3>チェックリスト（高レベル）</h3>
        <div><label><input type="checkbox" class="cult-cb"> 作業前準備（安全/清拭/器具確認）</label></div>
        <div><label><input type="checkbox" class="cult-cb"> 培地/試薬準備</label></div>
        <div><label><input type="checkbox" class="cult-cb"> 継代または播種（SOP通り）</label></div>
        <div><label><input type="checkbox" class="cult-cb"> 片付け・記録</label></div>
        <div style="margin-top:8px;"><button class="btn btn-ghost" onclick="clearChecklist('cult-cb')">全クリア</button></div>
      </div>
      <div class="card">
        <h3>記録フォーム</h3>
        <div class="field"><div>セルライン</div><div><input type="text" id="cultCell"></div></div>
        <div class="field"><div>パッセージ（任意）</div><div><input type="text" id="cultPassage" placeholder="例: P12"></div></div>
        <div class="field"><div>容器/条件（任意）</div><div><input type="text" id="cultVessel" placeholder="例: T25 ×1"></div></div>
        <div class="field"><div>担当</div><div><input type="text" id="cultWho"></div></div>
        <div class="field"><div>日付</div><div><input type="date" id="cultDate"></div></div>
        <div class="field"><div>メモ</div><div><input type="text" id="cultNote"></div></div>
        <div style="display:flex;gap:8px;"><button class="btn" onclick="cultAdd()">追加</button><button class="btn" onclick="cultExport()">CSVエクスポート</button></div>
      </div>
      <div class="card"><h3>記録一覧</h3><div id="cultTable" class="note">まだ記録がありません。</div></div>
    </section>

    <!-- ======================= Passage SOP ======================= -->
    <section id="tab-passage" style="display:none;">
      <div class="card">
        <h3>細胞継代（付着型 / 浮遊型）</h3>
        <div class="field"><div>タイプ</div><div>
          <label><input type="radio" name="passType" value="adherent" checked> 付着型</label>
          <label style="margin-left:12px;"><input type="radio" name="passType" value="suspension"> 浮遊型</label>
        </div></div>
        <div id="passageSteps">読み込み中…</div>
      </div>
      <div class="card">
        <h3>継代ログ</h3>
        <div class="field"><div>セルライン</div><div><input type="text" id="passCell"></div></div>
        <div class="field"><div>パッセージ</div><div><input type="text" id="passPsg" placeholder="例: P12"></div></div>
        <div class="field"><div>担当</div><div><input type="text" id="passWho"></div></div>
        <div class="field"><div>日付</div><div><input type="date" id="passDate"></div></div>
        <div class="field"><div>メモ</div><div><input type="text" id="passNote" placeholder="播種量/容器等"></div></div>
        <div style="display:flex;gap:8px;"><button class="btn" onclick="passAdd()">追加</button><button class="btn" onclick="passExport()">CSVエクスポート</button></div>
      </div>
      <div class="card"><h3>記録一覧</h3><div id="passTable" class="note">まだ記録がありません。</div></div>
    </section>

    <!-- ======================= Thaw SOP ======================= -->
    <section id="tab-thaw" style="display:none;">
      <div class="card">
        <h3>凍結細胞の解凍と再培養</h3>
        <div id="thawSteps">読み込み中…</div>
      </div>
    </section>

    <!-- ======================= Freeze SOP ======================= -->
    <section id="tab-freeze" style="display:none;">
      <div class="card">
        <h3>細胞の凍結保存</h3>
        <div id="freezeSteps">読み込み中…</div>
      </div>
    </section>

    <!-- ======================= Recipes ======================= -->
    <section id="tab-recipes" style="display:none;">
      <div class="card">
        <h3>ストック溶液レシピ</h3>
        <div class="field"><div>レシピ</div><div>
          <select id="recipeKind">
            <option value="PBS1x" selected>PBS(-) 1×（500 mL）</option>
            <option value="TB_0_4">トリパンブルー 0.4%（100 mL）</option>
          </select>
        </div></div>
        <div class="field"><div>換算体積</div><div><input type="number" id="recipeVol" value="1" step="0.1"><span class="suffix">倍（既定ロットに対して）</span></div></div>
        <button class="btn" onclick="calcRecipe()">計算</button>
      </div>
      <div class="card" id="recipeOut"><div class="note">上の「計算」を押してください。</div></div>
    </section>

    <!-- ======================= Vessels ======================= -->
    <section id="tab-vessels" style="display:none;">
      <div class="card"><h3>代表的な培養容器（目安）</h3><div id="vessels_table" class="note">読み込み中…</div></div>
    </section>

    <!-- ======================= Units ======================= -->
    <section id="tab-units" style="display:none;">
      <div class="card"><h3>体積・質量・濃度 かんたん変換</h3>
        <div class="field"><div>カテゴリ</div><div><select id="u_cat"><option value="vol">体積</option><option value="mass">質量</option><option value="conc">濃度（mg/mL, g/L, %w/v）</option></select></div></div>
        <div class="field"><div>値</div><div><input type="number" id="u_val" step="0.000001" value="1"></div></div>
        <div class="field"><div>単位（From）</div><div><select id="u_from"></select></div></div>
        <div class="field"><div>単位（To）</div><div><select id="u_to"></select></div></div>
        <div style="display:flex;gap:8px;"><button class="btn" onclick="convUnits()">変換</button><button class="btn" onclick="clearForm('tab-units')">クリア</button></div>
      </div>
      <div class="card"><h3>結果</h3><div class="row"><div>変換後</div><div class="value" id="u_out">—</div></div></div>
    </section>
  </div>
</div>

<script>
// ===== Tabs =====
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab=btn.dataset.tab;
    document.querySelectorAll('.panel > section').forEach(sec=>sec.style.display='none');
    document.getElementById('tab-'+tab).style.display='block';
  });
});

// ===== Helpers =====
function n(v){ const x=Number(v); return Number.isFinite(x)?x:0; }
function fmt(x,d=2){ if(!Number.isFinite(x)) return '—'; return x.toLocaleString(undefined,{maximumFractionDigits:d}); }
function fmtSciHTML(val){
  const x = Number(val);
  if(!Number.isFinite(x) || x===0) return '0';
  const e = Math.floor(Math.log10(Math.abs(x)));
  const m = x / Math.pow(10,e);
  return m.toFixed(3) + '×10<sup>' + e + '</sup>';
}
function toCSV(rows){ if(!rows.length) return ''; const keys=Object.keys(rows[0]); const esc=s=>`"${String(s??'').replace(/"/g,'""')}"`; return [keys.map(esc).join(','), ...rows.map(r=>keys.map(k=>esc(r[k])).join(','))].join('\n'); }
function downloadCSV(filename, rows){ const csv=toCSV(rows); if(!csv) return; const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function renderTable(el, rows){ if(!rows.length){ el.innerHTML='<div class="note">まだ記録がありません。</div>'; return; } const keys=Object.keys(rows[0]); let html='<table><thead><tr>'+keys.map(k=>'<th>'+k+'</th>').join('')+'</tr></thead><tbody>'; html+=rows.map(r=>'<tr>'+keys.map(k=>'<td>'+(r[k]??'')+'</td>').join('')+'</tr>').join(''); html+='</tbody></table>'; el.innerHTML=html; }
function clearChecklist(cls){ document.querySelectorAll('.'+cls).forEach(c=>c.checked=false); }
function clearForm(sectionId){ const sec=document.getElementById(sectionId); sec.querySelectorAll('input[type=number],input[type=text],input[type=date],textarea').forEach(el=>{ if(!el.readOnly){ el.value=''; }}); sec.querySelectorAll('select').forEach(s=>s.selectedIndex=0); }
function ymd(d){ const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2); return y+'-'+m+'-'+dd; }
function addDays(d,days){ const t=new Date(d); t.setDate(t.getDate()+days); return t; }
function mondayOf(d){ const t=new Date(d); const day=(t.getDay()+6)%7; t.setDate(t.getDate()-day); return new Date(t.getFullYear(),t.getMonth(),t.getDate()); }

// ===== Cells (auto-calc + save) =====
function saveCells(){
  const data = {
    squares: document.getElementById('squares').value,
    liveTotal: document.getElementById('liveTotal').value,
    deadTotal: document.getElementById('deadTotal').value,
    stockVol: document.getElementById('stockVol').value,
    tbVol: document.getElementById('tbVol').value,
    frozenVol: document.getElementById('frozenVol').value,
    containerVol: document.getElementById('containerVol').value,
    targetConc: document.getElementById('targetConc').value,
  };
  localStorage.setItem('cells_inputs', JSON.stringify(data));
}
function loadCells(){
  const raw = localStorage.getItem('cells_inputs'); if(!raw) return;
  try{
    const d=JSON.parse(raw);
    for(const k of Object.keys(d)){
      const el=document.getElementById(k);
      if(el && d[k]!==undefined) el.value=d[k];
    }
  }catch(e){}
}
function calcCells(){
  const squares=Math.max(1,n(document.getElementById('squares').value));
  const liveSum=n(document.getElementById('liveTotal').value);
  const deadSum=n(document.getElementById('deadTotal').value);
  const stock=n(document.getElementById('stockVol').value);
  const tb=n(document.getElementById('tbVol').value);
  const frozenVol=n(document.getElementById('frozenVol').value);
  const containerVol=n(document.getElementById('containerVol').value);
  const targetConc=n(document.getElementById('targetConc').value);

  const DF=stock>0?(stock+tb)/stock:1;
  const liveAvg=liveSum/squares;
  const totalAvg=(liveSum+deadSum)/squares;
  const viab=totalAvg>0?(liveAvg/totalAvg)*100:0;
  const liveConc=liveAvg*DF*1e4;
  const totalConc=totalAvg*DF*1e4;
  const frozenCells=frozenVol*totalConc;
  const containerLive=containerVol*liveConc;
  const needCellVol=liveConc>0?(targetConc/liveConc)*containerVol:0;
  const needMedia=containerVol-needCellVol;

  document.getElementById('r_liveSum').textContent=fmt(liveSum,0);
  document.getElementById('r_liveAvg').innerHTML=fmt(liveAvg,2)+' （= '+fmtSciHTML(liveAvg)+' ）';
  document.getElementById('r_deadSum').textContent=fmt(deadSum,0);
  document.getElementById('r_deadAvg').innerHTML=fmt(deadSum/squares,2)+' （= '+fmtSciHTML(deadSum/squares)+' ）';
  document.getElementById('r_totalSum').textContent=fmt(liveSum+deadSum,0);
  document.getElementById('r_totalAvg').innerHTML=fmt(totalAvg,2)+' （= '+fmtSciHTML(totalAvg)+' ）';
  document.getElementById('r_totalMix').textContent=fmt(stock+tb,2)+' µL';
  document.getElementById('r_DF').textContent=fmt(DF,3);
  document.getElementById('r_viab').textContent=fmt(viab,2)+' %';
  document.getElementById('r_liveConc').innerHTML=fmt(liveConc,0)+' cells/mL（= '+fmtSciHTML(liveConc)+' ）';
  document.getElementById('r_totalConc').innerHTML=fmt(totalConc,0)+' cells/mL（= '+fmtSciHTML(totalConc)+' ）';
  document.getElementById('r_frozen').innerHTML=fmt(frozenCells,0)+' cells（= '+fmtSciHTML(frozenCells)+' ）';
  document.getElementById('r_container').innerHTML=fmt(containerLive,0)+' cells（= '+fmtSciHTML(containerLive)+' ）';
  document.getElementById('r_needCellVol').textContent=fmt(needCellVol,3)+' mL';
  document.getElementById('r_needMedia').textContent=fmt(needMedia,3)+' mL';
  document.getElementById('cellsWarn').style.display=(needCellVol>containerVol+1e-12 || needMedia<-1e-12)?'block':'none';

  // くわしい式の補足
  document.getElementById('cellsExplain').innerHTML =
    '希釈倍率 DF = (細胞液 '+fmt(stock,2)+' + TB '+fmt(tb,2)+') / 細胞液 '+fmt(stock,2)
    + ' = <b>'+fmt(DF,3)+'</b><br>'
    + '生平均 = 生合計 '+fmt(liveSum,0)+' / マス '+fmt(squares,0)+' = '+fmt(liveAvg,2)
    + ' → 生細胞濃度 = 生平均 × DF × 10<sup>4</sup> = <b>'+fmt(liveConc,0)+'</b> cells/mL';
}
document.querySelectorAll('#tab-cells input').forEach(el=>{
  el.addEventListener('input', ()=>{ saveCells(); calcCells(); });
});

// ===== Doubling (auto-calc + save) =====
function goalKind(){ const r = document.querySelector('input[name="dbw_goal"]:checked'); return r ? r.value : 'conc'; }
function gPerDay(){ const DTh = n(document.getElementById('dbw_DTh')?.value); return DTh>0 ? Math.pow(2, 24/DTh) : 2; }
function renderGoalUI(){
  const g = goalKind();
  document.getElementById('dbw_targetC').disabled    = (g!=='conc');
  document.getElementById('dbw_targetCells').disabled = (g!=='cells');
  document.getElementById('dbw_useVol').disabled      = (g!=='cells');
}
function saveDBW(){
  const data = {
    start:  document.getElementById('dbw_start')?.value||'',
    C0:     document.getElementById('dbw_C0')?.value||'',
    DTh:    document.getElementById('dbw_DTh')?.value||'',
    passDay:document.getElementById('dbw_passDay')?.value||'2',
    expDay: document.getElementById('dbw_expDay')?.value||'4',
    goal:   goalKind(),
    targetC:document.getElementById('dbw_targetC')?.value||'',
    targetCells:document.getElementById('dbw_targetCells')?.value||'',
    useVol: document.getElementById('dbw_useVol')?.value||'',
  };
  localStorage.setItem('dbw_inputs', JSON.stringify(data));
}
function loadDBW(){
  const raw = localStorage.getItem('dbw_inputs'); if(!raw){ renderGoalUI(); return; }
  try{
    const d=JSON.parse(raw);
    if(d.start)   document.getElementById('dbw_start').value = d.start;
    if(d.C0)      document.getElementById('dbw_C0').value = d.C0;
    if(d.DTh)     document.getElementById('dbw_DTh').value = d.DTh;
    if(d.passDay) document.getElementById('dbw_passDay').value = d.passDay;
    if(d.expDay)  document.getElementById('dbw_expDay').value  = d.expDay;
    const g = d.goal || 'conc';
    const r = document.querySelector(`input[name="dbw_goal"][value="${g}"]`); if(r) r.checked = true;
    if(d.targetC)     document.getElementById('dbw_targetC').value = d.targetC;
    if(d.targetCells) document.getElementById('dbw_targetCells').value = d.targetCells;
    if(d.useVol)      document.getElementById('dbw_useVol').value = d.useVol;
  }catch(e){}
  renderGoalUI();
}
function planWeek(){
  const tableEl = document.getElementById('dbw_table'); if(!tableEl) return;

  let start = document.getElementById('dbw_start')?.value;
  if(!start){ const mon=mondayOf(new Date()); document.getElementById('dbw_start').value=ymd(mon); start=ymd(mon); }
  const startDate = new Date(start+'T00:00:00');

  let C = n(document.getElementById('dbw_C0')?.value);
  const passDay = n(document.getElementById('dbw_passDay')?.value);
  const expDay  = n(document.getElementById('dbw_expDay')?.value);
  const gDay    = gPerDay();

  const goal = goalKind();
  const targetC_input = n(document.getElementById('dbw_targetC')?.value);
  const targetCells   = n(document.getElementById('dbw_targetCells')?.value);
  const useVol_mL     = n(document.getElementById('dbw_useVol')?.value);

  let targetC_forPlan = 0;
  if(goal==='conc' && targetC_input>0) targetC_forPlan = targetC_input;
  else if(goal==='cells' && targetCells>0 && useVol_mL>0) targetC_forPlan = targetCells / useVol_mL;

  const rows = []; let CexpMorning = 0;
  for(let d=0; d<7; d++){
    const date = addDays(startDate, d);
    const C_pre = C; let opText=''; let C_after=null;

    if(d===passDay && targetC_forPlan>0 && C_pre>0){
      const daysToExp = (expDay - d + 7) % 7;
      const neededAfter = targetC_forPlan / Math.pow(gDay, daysToExp);
      const f = C_pre / neededAfter; // 希釈倍数（1:f）
      if(Number.isFinite(f) && f>0){
        opText = (f>=1) ? `${f.toFixed(2)}倍希釈（1:${f.toFixed(2)}）` : `濃縮 × ${(1/f).toFixed(2)}`;
        C_after = neededAfter;
      }
    }
    const C_end_num = (C_after ?? C_pre) * gDay;

    rows.push({
      '日付': ymd(date)+'（' + ['月','火','水','木','金','土','日'][d] + '）',
      '朝の濃度': `${C_pre.toLocaleString()}（= ${fmtSciHTML(C_pre)}）`,
      '操作': opText,
      '当日終わりの濃度': `${C_end_num.toLocaleString()}（= ${fmtSciHTML(C_end_num)}）`,
    });

    C = C_end_num;
    if(((d+1)%7)===expDay){ CexpMorning = C; }
  }

  // 表描画
  let html='<table><thead><tr>';
  const keys = Object.keys(rows[0]||{'—':'—'}); keys.forEach(k=> html+=`<th>${k}</th>`); html+='</tr></thead><tbody>';
  html += rows.map(r=>'<tr>'+keys.map(k=>`<td>${r[k]??''}</td>`).join('')+'</tr>').join('');
  html+='</tbody></table>';
  tableEl.innerHTML=html;

  // サマリ
  const sumC = document.getElementById('dbw_sum_Cexp');
  const sumN = document.getElementById('dbw_sum_needN');
  const sumV = document.getElementById('dbw_sum_Vneed');
  const sumT = document.getElementById('dbw_sum_targetC');
  const warn = document.getElementById('dbw_warn');

  sumC.innerHTML = CexpMorning ? `${CexpMorning.toLocaleString()}（= ${fmtSciHTML(CexpMorning)}） cells/mL` : '—';

  if(goal==='conc' && targetC_input>0){
    sumT.innerHTML = `${targetC_input.toLocaleString()}（= ${fmtSciHTML(targetC_input)}） cells/mL`;
    sumN.textContent = '—'; sumV.textContent='—'; warn.style.display='none';
  }else if(goal==='cells' && targetCells>0){
    sumN.textContent = targetCells.toLocaleString()+' cells';
    const Vneed = CexpMorning>0 ? (targetCells / CexpMorning) : NaN;
    sumV.textContent = Number.isFinite(Vneed) ? fmt(Vneed,3)+' mL' : '—';
    // 参考：指定体積があれば必要濃度も表示
    if(useVol_mL>0){ sumT.innerHTML = fmt(targetCells/useVol_mL,0)+'（= '+fmtSciHTML(targetCells/useVol_mL)+'） cells/mL'; }
    warn.style.display = (useVol_mL>0 && Number.isFinite(Vneed) && Vneed>useVol_mL) ? 'block' : 'none';
  }else{
    sumT.textContent='—'; sumN.textContent='—'; sumV.textContent='—'; warn.style.display='none';
  }
}
// 入力イベントで即再計算＆保存
['dbw_start','dbw_C0','dbw_DTh','dbw_passDay','dbw_expDay','dbw_targetC','dbw_targetCells','dbw_useVol'].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
});
document.addEventListener('input', (e)=>{
  const id=(e.target||{}).id||'';
  if(/^dbw_/.test(id)){ saveDBW(); renderGoalUI(); planWeek(); }
});
document.querySelectorAll('input[name="dbw_goal"]').forEach(r=>{
  r.addEventListener('change', ()=>{ renderGoalUI(); saveDBW(); planWeek(); });
});

// ===== Reagents (presets + calcs) =====
const REAGENTS = [
  { id:'mem',  name:'MEM培地',  method:'MEM培地 0.94 g を V2 に溶解 → オートクレーブ滅菌。', note:'製品の添付文書/SOPを最優先。', preset:{ mode:'percent', pct:0.94 } },
  { id:'rpmi', name:'RPMI1640培地', method:'RPMI1640 1.02 g を V2 に溶解 → オートクレーブ滅菌。', note:'製品の添付文書/SOPを最優先。', preset:{ mode:'percent', pct:1.02 } },
  { id:'nahco3_10', name:'10% NaHCO₃', method:'NaHCO₃ 10.0 g を V2=100 mL に溶解 → オートクレーブ。', note:'', preset:{ mode:'percent', pct:10 } },
  { id:'gln_3', name:'3% グルタミン', method:'超純水 10 mL に 0.3 g 溶解 → 0.22 µm ろ過 → 15 mL チューブで凍結保存。', note:'', preset:{ mode:'percent', pct:3 } },
  { id:'strep_100mg', name:'100 mg/mL ストレプトマイシン', method:'超純水 5 mL に 0.5 g 溶解 → 0.22 µm ろ過 → 凍結保存。', note:'', preset:{ mode:'c1v1', C1:100, C2:100, unit:'mg/mL' } },
  { id:'pen_100k', name:'100,000 U/mL ペニシリン', method:'超純水 5 mL に 500,000 U 相当量を溶解 → 0.22 µm ろ過 → 凍結保存。', note:'力価換算は製品規定に従う。', preset:{ mode:'c1v1', C1:100000, C2:100000, unit:'U/mL' } },
  { id:'tb_0_4', name:'0.4% トリパンブルー', method:'粉末から 0.4%（w/v）に調製 → 0.22 µm ろ過。暗所保存。', note:'', preset:{ mode:'percent', pct:0.4 } },
  { id:'pbs1x', name:'1× PBS(-)', method:'NaCl 4.0 g, KCl 0.1 g, Na₂HPO₄·12H₂O 1.45 g, KH₂PO₄ 0.1 g → 500 mL に定容 → オートクレーブ。', note:'', preset:{} },
];
function renderReagTable(){
  const rows = REAGENTS.map(r=>({ 項目:r.name, 調整方法:r.method, 注意点:r.note }));
  renderTable(document.getElementById('reagTable'), rows);
}
function setV2(v){ const el=document.getElementById('V2'); el.value=v; calcC1V1(); calcPercent(); calcFactor(); }
document.getElementById('reagPreset').addEventListener('change', ()=>{
  const id = document.getElementById('reagPreset').value;
  const r = REAGENTS.find(x=>x.id===id);
  if(!r) return;
  document.getElementById('reagGuide').innerHTML = `<div class="note"><strong>${r.name}</strong><br>${r.method}${r.note?('<br>注意：'+r.note):''}</div>`;
  fillFromPreset();
  calcC1V1(); calcPercent(); calcFactor();
});
function fillFromPreset(){
  const id=document.getElementById('reagPreset').value;
  const r=REAGENTS.find(x=>x.id===id); if(!r) return;
  if(r.preset.mode==='percent'){ document.getElementById('pct').value = r.preset.pct ?? ''; }
  else if(r.preset.mode==='c1v1'){ document.getElementById('C1').value=r.preset.C1??''; document.getElementById('C2').value=r.preset.C2??''; document.getElementById('unitC').textContent=r.preset.unit||'mg/mL'; document.getElementById('unitC2').textContent='（同上）'; }
}
function calcC1V1(){
  const C1=n(document.getElementById('C1').value), C2=n(document.getElementById('C2').value), V2=n(document.getElementById('V2').value);
  const warn=document.getElementById('reagWarn');
  if(C1<=0 || V2<=0){ document.getElementById('r_v1').textContent='— mL'; document.getElementById('r_dil').textContent='— mL'; if(warn) warn.style.display='block'; return; }
  const V1 = (C2*V2)/C1, dil=V2-V1;
  document.getElementById('r_v1').textContent=(V1>=0?fmt(V1,3)+' mL':'—');
  document.getElementById('r_dil').textContent=(dil>=0?fmt(dil,3)+' mL':'—');
  if(warn) warn.style.display = (V1<0 || dil<0)?'block':'none';
}
function calcPercent(){
  const pct=n(document.getElementById('pct').value), V2=n(document.getElementById('V2').value);
  if(pct<=0 || V2<=0){ document.getElementById('r_grams').textContent='— g（定容で — mL）'; return; }
  const g=(pct/100)*V2;
  document.getElementById('r_grams').textContent=fmt(g,3)+' g（定容で '+fmt(V2,0)+' mL）';
}
function calcFactor(){
  const stockX=n(document.getElementById('stockFactor').value), finalX=n(document.getElementById('finalFactor').value), V2=n(document.getElementById('V2').value);
  const warn=document.getElementById('reagWarn');
  if(stockX<=0 || finalX<=0 || V2<=0){ document.getElementById('r_fx_v1').textContent='— mL'; document.getElementById('r_fx_dil').textContent='— mL'; if(warn) warn.style.display='block'; return; }
  const V1=V2*(finalX/stockX), dil=V2-V1;
  document.getElementById('r_fx_v1').textContent=fmt(V1,3)+' mL';
  document.getElementById('r_fx_dil').textContent=fmt(dil,3)+' mL';
  if(warn) warn.style.display=(V1<0||dil<0)?'block':'none';
}

// ===== Sterile DB =====
const STERILE_DB = {
  methods: {
    autoclave121:{ name:'オートクレーブ（121°C 15–20分）', detail:'液体は液体プログラム。自然冷却。キャップを緩める。', caution:'沸騰・噴出、過充填に注意。' },
    autoclave134:{ name:'オートクレーブ（134°C 3–5分）', detail:'器具向け（プレバキューム）', caution:'樹脂は変形リスク。' },
    dryheat175:  { name:'乾熱滅菌（175°C 1.5時間 / 180°C 30分）', detail:'ガラス/陶器/金属向け。', caution:'樹脂NG。耐熱確認。' },
    filtration022:{ name:'ろ過滅菌（0.22 µm 推奨 / 0.45 µm 可）', detail:'加熱不可の溶液（ビタミン/血清など）。', caution:'ウイルスは除去できない。高粘度は詰まり注意。' },
    chem70:      { name:'化学的：70%エタノール', detail:'十分に濡らし10分接触→乾燥。', caution:'可燃・火気厳禁。' },
    uv:          { name:'UV（260 nm付近 15–30分/面）', detail:'10–20 cm、影を作らない配置。', caution:'眼・皮膚保護必須。表面のみ有効。' },
    flame:       { name:'炎焼却（フレーム）', detail:'白金耳/白金線の先端を短時間赤熱。', caution:'可燃物・エアロゾル注意。' },
    gamma_eog:   { name:'市販滅菌品（γ線/EOG）', detail:'耐熱NG製品は滅菌済み新品を使用。', caution:'再滅菌不可の製品あり。取説/ラベル確認。' },
  },
  items: [
    { id:'media_heat_ok', group:'溶液/培地', name:'培地・溶液（熱変性を起こさない）', methods:['autoclave121'], avoid:[] },
    { id:'media_heat_ng', group:'溶液/培地', name:'溶液（熱に弱い/成分変性の恐れ）', methods:['filtration022','uv'], avoid:['autoclave121','dryheat175'] },
    { id:'vitamins', group:'溶液/培地', name:'ビタミン類', methods:['filtration022'], avoid:['autoclave121','dryheat175'] },
    { id:'serum',    group:'溶液/培地', name:'血清', methods:['filtration022'], avoid:['autoclave121','dryheat175'] },
    { id:'glass_autoclave', group:'器具（ガラス/金属）', name:'ガラス器具（オートクレーブ）', methods:['autoclave121'], avoid:[] },
    { id:'glass_dry',       group:'器具（ガラス/金属）', name:'ガラス器具（乾熱）', methods:['dryheat175'], avoid:[] },
    { id:'porcelain',       group:'器具（ガラス/金属）', name:'陶器', methods:['dryheat175'], avoid:[] },
    { id:'metal_autoclave', group:'器具（ガラス/金属）', name:'金属器具（オートクレーブ）', methods:['autoclave134','autoclave121'], avoid:[] },
    { id:'platinum_loop',   group:'器具（ガラス/金属）', name:'白金耳/白金線', methods:['flame'], avoid:[] },
    { id:'pipette_tips_pp', group:'器具（プラスチック）', name:'ピペットチップ（PP）', methods:['autoclave121','uv','chem70'], avoid:['dryheat175'] },
    { id:'microtube_pp',    group:'器具（プラスチック）', name:'マイクロチューブ（PP）', methods:['autoclave121'], avoid:['dryheat175','uv'] },
    { id:'centrifuge_pp',   group:'器具（プラスチック）', name:'遠沈管 15/50 mL（PP）', methods:['autoclave121'], avoid:['dryheat175'] },
    { id:'centrifuge_ps',   group:'器具（プラスチック）', name:'遠沈管 15/50 mL（PS）', methods:['uv','chem70','gamma_eog'], avoid:['autoclave121','dryheat175'] },
    { id:'petri_ps',        group:'器具（プラスチック）', name:'シャーレ（PS）', methods:['uv','chem70','gamma_eog'], avoid:['autoclave121','dryheat175'] },
    { id:'bio_waste',       group:'微生物/廃棄', name:'微生物での汚染物の廃棄', methods:['autoclave121'], avoid:[] },
  ],
};
function methodKeyToCategory(key){
  if(key.startsWith('autoclave')) return 'オートクレーブ';
  if(key==='dryheat175') return '乾熱';
  if(key==='filtration022') return 'ろ過';
  if(key==='chem70') return '化学';
  if(key==='uv') return 'UV';
  if(key==='flame') return '炎焼却';
  if(key==='gamma_eog') return '市販滅菌品';
  return '';
}
function sterileInitCatalog(){
  const sel=document.getElementById('sterileCatalog'); if(!sel) return;
  const order=['溶液/培地','器具（ガラス/金属）','器具（プラスチック）','微生物/廃棄'];
  sel.innerHTML = order.map(g=>{
    const opts = STERILE_DB.items.filter(i=>i.group===g)
      .map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
    return `<optgroup label="${g}">${opts}</optgroup>`;
  }).join('');
  sel.addEventListener('change', renderSterileSuggest);
  document.getElementById('optHasLiquid')?.addEventListener('change', renderSterileSuggest);
  renderSterileSuggest();
}
function renderSterileSuggest(){
  const sel=document.getElementById('sterileCatalog');
  const out=document.getElementById('sterileSuggest');
  if(!sel || !out) return;
  const hasLiq = !!document.getElementById('optHasLiquid')?.checked;
  const it = STERILE_DB.items.find(x=>x.id===sel.value);
  if(!it){ out.textContent='対象物を選んでください。'; return; }

  let methods = [...it.methods];
  if(['media_heat_ng','vitamins','serum'].includes(it.id)){
    methods.sort((a,b)=> (a==='filtration022'? -1:0) - (b==='filtration022'? -1:0));
  }else{
    methods.sort((a,b)=> (a.startsWith('autoclave')? -1:0) - (b.startsWith('autoclave')? -1:0));
  }
  if(hasLiq && methods.includes('autoclave121')){
    methods = ['autoclave121', ...methods.filter(m=>m!=='autoclave121')];
  }
  const cards = methods.map(key=>{
    const m=STERILE_DB.methods[key]; if(!m) return '';
    return `
      <div class="card" style="margin:8px 0;border-color:#edf0ff">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
          <div>
            <strong>${m.name}</strong>
            <div class="note">${m.detail}</div>
            <div class="note">注意：${m.caution}</div>
          </div>
          <button class="btn" onclick="sterileCopyToForm('${it.name}','${key}')">記録にコピー</button>
        </div>
      </div>`;
  }).join('');
  const avoid = it.avoid?.length ? `<div class="note">避けたい方法：${it.avoid.map(k=>STERILE_DB.methods[k]?.name||k).join('、')}</div>` : '';
  out.innerHTML = `<div class="note">選択：<strong>${it.name}</strong>${hasLiq?'（液体）':''}</div>${cards}${avoid}<div class="note">※ 最終判断は所属ラボのSOPに従ってください。</div>`;
}
function sterileCopyToForm(itemName, methodKey){
  const item=document.getElementById('sterileItem'), method=document.getElementById('sterileMethod'), note=document.getElementById('sterileNote');
  const cat = methodKeyToCategory(methodKey); const detail = STERILE_DB.methods[methodKey]?.name || methodKey;
  if(item) item.value=itemName; if(method && cat) method.value=cat; if(note) note.value=('カタログ: '+detail);
}
function sterileAdd(){
  const rows = JSON.parse(localStorage.getItem('sterileRows')||'[]');
  rows.push({ 器材:document.getElementById('sterileItem').value||'', 方法:document.getElementById('sterileMethod').value||'', 担当:document.getElementById('sterileWho').value||'', 日付:document.getElementById('sterileDate').value||'', メモ:document.getElementById('sterileNote').value||'' });
  localStorage.setItem('sterileRows', JSON.stringify(rows));
  renderTable(document.getElementById('sterileTable'), rows);
}
function sterileExport(){ const rows = JSON.parse(localStorage.getItem('sterileRows')||'[]'); downloadCSV('sterile_log.csv', rows); }

// ===== SOP steps (split, no arrows; checkboxes; saved state) =====
const SOP_STEPS = {
  freeze: [
    '培養液を吸引除去',
    'PBS(-) 3 mL を加え、培養表面を洗浄',
    'PBS を吸引除去',
    'トリプシン 2 mL を加える（室温放置、剥離を観察）',
    '大部分が球状になったら培地 2 mL を加えて反応停止',
    'ピペッティングで懸濁して均一化',
    '細胞浮遊液を 15 mL 遠沈管へ移す',
    '必要に応じて追加分も回収',
    '細胞計数（トリパンブルー 1:1 など）',
    '遠心 190–200 g（約 1,000 rpm）3 分',
    '上清をゆっくり除去',
    'ペレットを軽くほぐす',
    '氷冷の凍結用培地で懸濁（例：1×10^6 cells/mL）',
    'ラベル済み凍結バイアルに 1 mL ずつ分注',
    '凍結用断熱容器へ入れ -80℃、のち液体窒素保管（SOP準拠）',
    '記録（細胞名、継代数、日付、氏名、本数、濃度）'
  ],
  thaw: [
    '15 mL コニカルに培地 9 mL を準備（温めた培地推奨）',
    '凍結バイアルを素早く解凍（37℃、キャップ水没NG）',
    '細胞懸濁液 ~1 mL を培地 9 mL の管へゆっくり移す',
    '遠心 190–200 g（約 1,000 rpm）3 分',
    '上清を除去',
    'ペレットをタッピングでほぐす',
    '培地 1 mL でピペッティングして均一懸濁',
    '細胞計数と生存率の確認',
    '必要濃度・液量を計算して調製（例：4×10^4 cells/mL を 16 mL）',
    '適切な容器に分配（例：10 cm 皿に 10 mL、T-25 に 5 mL）',
    '顕微鏡で状態を確認し CO₂ インキュベータへ',
    '記録（セルライン、容器、播種細胞数/濃度、担当、日付）'
  ],
  passage_adherent: [
    '培養液を吸引除去',
    'PBS(-) で培養面を洗浄',
    'PBS を吸引除去',
    'トリプシンを加える（室温で剥離を観察）',
    '剥離を確認したら培地を加えて反応停止',
    'ピペッティングで均一化し 15 mL 遠沈管へ',
    '遠心 190–200 g（約 1,000 rpm）3 分',
    '上清を吸引除去',
    'ペレットをタッピングでほぐす',
    '少量培地で懸濁（計数用に一部取り分け）',
    '必要濃度を計算して容器に分注',
    '顕微鏡で確認 → インキュベータへ',
    '記録（セルライン、P数、分割比、播種量、担当、日付）'
  ],
  passage_suspension: [
    'フラスコを穏やかに混和して均一化',
    '必要量を取り 15 mL 遠沈管へ',
    '遠心 190–200 g（約 1,000 rpm）3 分',
    '上清を吸引除去',
    '新しい培地で所定濃度に再懸濁',
    '必要濃度を計算して新しい容器へ分注',
    '顕微鏡で確認 → インキュベータへ',
    '記録（セルライン、P数、分割比、播種量、担当、日付）'
  ],
};
function renderSOP(containerId, steps, storeKey){
  const el = document.getElementById(containerId); if(!el) return;
  const saved = JSON.parse(localStorage.getItem(storeKey) || '[]');
  let html = '<ol style="padding-left:20px;margin:8px 0">';
  steps.forEach((s, i)=>{
    const checked = saved[i] ? 'checked' : '';
    html += `<li style="margin:6px 0;"><label><input type="checkbox" data-k="${storeKey}" data-i="${i}" ${checked}> ${s}</label></li>`;
  });
  html += '</ol><div style="display:flex;gap:8px;flex-wrap:wrap;">'
       +  `<button class="btn" onclick="sopCheckAll('${storeKey}', true)">すべてチェック</button>`
       +  `<button class="btn" onclick="sopCheckAll('${storeKey}', false)">全クリア</button>`
       +  `<button class="btn" onclick="sopExport('${storeKey}')">CSVエクスポート</button>`
       +  '</div>';
  el.innerHTML = html;
  el.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', (e)=>{
      const k = e.target.getAttribute('data-k');
      const i = Number(e.target.getAttribute('data-i'));
      const arr = JSON.parse(localStorage.getItem(k) || '[]');
      arr[i] = e.target.checked;
      localStorage.setItem(k, JSON.stringify(arr));
    });
  });
}
function sopCheckAll(storeKey, on){
  const mapLen = { 'sop_freeze': SOP_STEPS.freeze.length, 'sop_thaw': SOP_STEPS.thaw.length, 'sop_pass_ad': SOP_STEPS.passage_adherent.length, 'sop_pass_sp': SOP_STEPS.passage_suspension.length };
  const v = Array(mapLen[storeKey]||0).fill(on);
  localStorage.setItem(storeKey, JSON.stringify(v));
  if(storeKey==='sop_freeze') renderSOP('freezeSteps',  SOP_STEPS.freeze, 'sop_freeze');
  if(storeKey==='sop_thaw')   renderSOP('thawSteps',    SOP_STEPS.thaw,   'sop_thaw');
  if(storeKey==='sop_pass_ad'||storeKey==='sop_pass_sp'){
    const type = document.querySelector('input[name="passType"]:checked')?.value || 'adherent';
    drawPassage(type);
  }
}
function sopExport(storeKey){
  const map = {
    'sop_freeze': {title:'freeze', steps:SOP_STEPS.freeze},
    'sop_thaw':   {title:'thaw',   steps:SOP_STEPS.thaw},
    'sop_pass_ad':{title:'passage_adherent',steps:SOP_STEPS.passage_adherent},
    'sop_pass_sp':{title:'passage_suspension',steps:SOP_STEPS.passage_suspension},
  };
  const {title, steps} = map[storeKey] || map['sop_freeze'];
  const flags = JSON.parse(localStorage.getItem(storeKey)||'[]');
  const rows = steps.map((s,i)=>({ step:i+1, done:flags[i]?'✔':'', text:s }));
  downloadCSV(`SOP_${title}.csv`, rows);
}
function drawPassage(type){
  if(type==='adherent') renderSOP('passageSteps', SOP_STEPS.passage_adherent, 'sop_pass_ad');
  else renderSOP('passageSteps', SOP_STEPS.passage_suspension, 'sop_pass_sp');
}
document.querySelectorAll('input[name="passType"]').forEach(r=> r.addEventListener('change', (e)=> drawPassage(e.target.value)));

// ===== Recipes (PBS / Trypan Blue) =====
function calcRecipe(){
  const kind=document.getElementById('recipeKind').value, mult=n(document.getElementById('recipeVol').value)||1;
  let html='';
  if(kind==='PBS1x'){
    html += row('定容', fmt(0.5*mult,3)+' L（超純水）');
    html += row('NaCl', fmt(4.0*mult,3)+' g');
    html += row('KCl', fmt(0.1*mult,3)+' g');
    html += row('Na₂HPO₄·12H₂O', fmt(1.45*mult,3)+' g');
    html += row('KH₂PO₄', fmt(0.1*mult,3)+' g');
    html += '<div class="note" style="margin-top:6px;">溶解→ 500 mL に定容 → オートクレーブ。必要に応じてフィルター滅菌を選択。</div>';
  }else{ // Trypan Blue 0.4% 100 mL ロット
    html += row('定容', fmt(0.1*mult,3)+' L（超純水）');
    html += row('粉末（TB）', fmt(0.4*mult,3)+' g');
    html += '<div class="note" style="margin-top:6px;">完全溶解後、0.22 µm でろ過滅菌。暗所保存。</div>';
  }
  document.getElementById('recipeOut').innerHTML = '<div class="row"><div>レシピ</div><div class="value">'+(kind==='PBS1x'?'PBS(-) 1×':'トリパンブルー 0.4%')+'</div></div>'+html;
  function row(a,b){ return `<div class="row"><div>${a}</div><div class="value">${b}</div></div>`; }
}

// ===== Vessels =====
const VESSELS = [
  {容器:'T-25 フラスコ', 面積:'25', 推奨液量:'5–7'},
  {容器:'T-75 フラスコ', 面積:'75', 推奨液量:'10–15'},
  {容器:'T-175 フラスコ', 面積:'175', 推奨液量:'25–35'},
  {容器:'6-well', 面積:'9.5/ウェル', 推奨液量:'2–3/ウェル'},
  {容器:'12-well', 面積:'3.8/ウェル', 推奨液量:'1–1.5/ウェル'},
  {容器:'24-well', 面積:'1.9/ウェル', 推奨液量:'0.4–0.8/ウェル'},
  {容器:'48-well', 面積:'1.0/ウェル', 推奨液量:'0.2–0.4/ウェル'},
  {容器:'96-well', 面積:'0.32/ウェル', 推奨液量:'0.1–0.2/ウェル'},
];
(function renderVessels(){
  const el=document.getElementById('vessels_table'); if(!el) return;
  const rows=VESSELS.map(r=>({容器:r.容器,'成長面積 (cm²)':r.面積,'推奨液量 (mL)':r.推奨液量}));
  let html='<table><thead><tr>';
  Object.keys(rows[0]).forEach(k=> html+='<th>'+k+'</th>'); html+='</tr></thead><tbody>';
  html += rows.map(r=>'<tr>'+Object.keys(rows[0]).map(k=>'<td>'+r[k]+'</td>').join('')+'</tr>').join('');
  html+='</tbody></table>'; el.innerHTML=html;
})();

// ===== Units =====
const UNITS = { vol:{ base:'L', list:{'µL':1e-6,'mL':1e-3,'L':1} }, mass:{ base:'g', list:{'mg':1e-3,'g':1,'kg':1e3} }, conc:{ base:'mg/mL', list:{'mg/mL':1,'g/L':1, '% w/v':10} } };
function fillUnitOptions(){
  const cat=document.getElementById('u_cat')?.value||'vol';
  const list = UNITS[cat].list;
  const from=document.getElementById('u_from'), to=document.getElementById('u_to');
  if(!from||!to) return;
  from.innerHTML=''; to.innerHTML='';
  Object.keys(list).forEach(k=>{
    const o1=document.createElement('option'); o1.textContent=k; o1.value=k; from.appendChild(o1);
    const o2=document.createElement('option'); o2.textContent=k; o2.value=k; to.appendChild(o2);
  });
  if(cat==='vol'){ from.value='mL'; to.value='µL'; }
  if(cat==='mass'){ from.value='mg'; to.value='g'; }
  if(cat==='conc'){ from.value='mg/mL'; to.value='g/L'; }
}
document.getElementById('u_cat')?.addEventListener('change', fillUnitOptions);
function convUnits(){
  const cat=document.getElementById('u_cat').value, val=n(document.getElementById('u_val').value), from=document.getElementById('u_from').value, to=document.getElementById('u_to').value;
  if(val===0){ document.getElementById('u_out').textContent='—'; return; }
  const baseVal = val * UNITS[cat].list[from];
  const res = baseVal / UNITS[cat].list[to];
  document.getElementById('u_out').textContent = res.toLocaleString(undefined,{maximumFractionDigits:6})+' '+to;
}

// ===== Logs common =====
function cultAdd(){ const rows = JSON.parse(localStorage.getItem('cultRows')||'[]'); rows.push({ セルライン:document.getElementById('cultCell').value||'', パッセージ:document.getElementById('cultPassage').value||'', 容器条件:document.getElementById('cultVessel').value||'', 担当:document.getElementById('cultWho').value||'', 日付:document.getElementById('cultDate').value||'', メモ:document.getElementById('cultNote').value||'' }); localStorage.setItem('cultRows', JSON.stringify(rows)); renderTable(document.getElementById('cultTable'), rows); }
function cultExport(){ const rows = JSON.parse(localStorage.getItem('cultRows')||'[]'); downloadCSV('culture_log.csv', rows); }
function passAdd(){ const rows = JSON.parse(localStorage.getItem('passRows')||'[]'); rows.push({ セルライン:document.getElementById('passCell').value||'', パッセージ:document.getElementById('passPsg').value||'', 担当:document.getElementById('passWho').value||'', 日付:document.getElementById('passDate').value||'', メモ:document.getElementById('passNote').value||'' }); localStorage.setItem('passRows', JSON.stringify(rows)); renderTable(document.getElementById('passTable'), rows); }
function passExport(){ const rows = JSON.parse(localStorage.getItem('passRows')||'[]'); downloadCSV('passage_log.csv', rows); }
function sterileExport(){ const rows = JSON.parse(localStorage.getItem('sterileRows')||'[]'); downloadCSV('sterile_log.csv', rows); }

// ===== Init =====
function init(){
  // Cells
  loadCells(); calcCells();
  // Doubling
  loadDBW(); renderGoalUI(); planWeek();
  // Reagents
  renderReagTable(); document.getElementById('reagPreset').value='mem'; document.getElementById('reagPreset').dispatchEvent(new Event('change'));
  // Sterile
  sterileInitCatalog();
  // SOP
  renderSOP('freezeSteps',  SOP_STEPS.freeze,  'sop_freeze');
  renderSOP('thawSteps',    SOP_STEPS.thaw,    'sop_thaw');
  drawPassage('adherent');
  // Units
  fillUnitOptions();
}
init();
</script>
</body>
</html>
