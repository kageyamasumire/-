<script>
function num(v){ if(v==null||v==='') return NaN; const s=String(v).replace(/[,\\s]/g,''); const x=parseFloat(s); return isFinite(x)?x:NaN; }
function fmt(v,d=6){ return isFinite(v)?Number(v).toLocaleString(undefined,{maximumSignificantDigits:d}):'0'; }
/* 濃度だけ指数表記（10^n）で表示 */
function sci(v, digits=2){ if(!isFinite(v)) return '0'; if(v===0) return '0'; const exp=Number(v).toExponential(digits); const [base,e]=exp.split('e'); const exponent=parseInt(e,10); return `${base} × 10<sup>${exponent}</sup>`; }

let state = {
  sumL:0, sumD:0, sumT:0, avgL:0, avgD:0, avgT:0, viab:0,
  Vorig_uL:0, Vtb_uL:0, mixVol_uL:0, DF:1,
  Clive:0, Ctotal:0, Vfreeze:0, Vwell:0, Ct:NaN,
  cellsTube:0, cellsVessel:0,
  // ▼ “式どおり”の生細胞液量・培地量（生で保持：負の値もあり）
  VsNeeded_raw:0, VmedNeeded_raw:0,
  // ▼ ガイド表示用（負の培地は0に丸め）
  VsNeeded:0, VmedNeeded:0
};

document.getElementById('addRow').addEventListener('click',()=>{
  const tb=document.querySelector('#tbl tbody');
  const i=tb.querySelectorAll('tr').length+1;
  const tr=document.createElement('tr');
  tr.innerHTML = `<td>${i}</td><td><input class="live" inputmode="decimal"></td><td><input class="dead" inputmode="decimal"></td><td class="total"></td>`;
  tb.appendChild(tr);
});

function calcCounts(){
  const rows=[...document.querySelectorAll('#tbl tbody tr')];
  let sumL=0,sumD=0,sumT=0,n=0;
  rows.forEach(tr=>{
    const l=num(tr.querySelector('.live').value);
    const d=num(tr.querySelector('.dead').value);
    const t=(isFinite(l)?l:0)+(isFinite(d)?d:0);
    tr.querySelector('.total').textContent = isFinite(t)? fmt(t,6) : '';
    if(isFinite(l)||isFinite(d)){ n++; if(isFinite(l)) sumL+=l; if(isFinite(d)) sumD+=d; sumT+=t; }
  });
  const avgL = n? sumL/n : 0;
  const avgD = n? sumD/n : 0;
  const avgT = n? sumT/n : 0;
  const viab = avgT>0 ? (avgL/avgT*100) : 0;
  Object.assign(state,{sumL, sumD, sumT, avgL, avgD, avgT, viab});
}

function renderCountsToStory(){
  const s=document.getElementById('story');
  s.innerHTML = `👀 生きている細胞の合計 <span class="num">${fmt(state.sumL,6)}</span>、平均 <span class="num">${fmt(state.avgL,6)}</span><br>
  😴 死んでいる細胞の合計 <span class="num">${fmt(state.sumD,6)}</span>、平均 <span class="num">${fmt(state.avgD,6)}</span><br>
  ➕ 全部の合計 <span class="num">${fmt(state.sumT,6)}</span>、平均 <span class="num">${fmt(state.avgT,6)}</span><br>
  💚 生存率 <span class="num">${state.avgT>0? state.viab.toFixed(2):'0'}</span> %`;
}

function renderAllToSummary(){
  document.getElementById('sumLive').textContent = fmt(state.sumL,6);
  document.getElementById('avgLive').textContent = fmt(state.avgL,6);
  document.getElementById('sumDead').textContent = fmt(state.sumD,6);
  document.getElementById('avgDead').textContent = fmt(state.avgD,6);
  document.getElementById('sumTotal').textContent = fmt(state.sumT,6);
  document.getElementById('avgTotal').textContent = fmt(state.avgT,6);

  document.getElementById('mixVol').textContent = `${fmt(state.mixVol_uL,6)} µL`;
  document.getElementById('DF').textContent = fmt(state.DF,6);
  document.getElementById('viab').textContent = `${state.avgT>0? state.viab.toFixed(2):'0'} %`;

  document.getElementById('Clive').innerHTML = `${sci(state.Clive,2)} cells/mL`;
  document.getElementById('Ctotal').innerHTML = `${sci(state.Ctotal,2)} cells/mL`;

  document.getElementById('cellsTube').textContent = isFinite(state.cellsTube)? `${fmt(state.cellsTube,6)} cells` : '0 cells';
  document.getElementById('cellsVessel').textContent = isFinite(state.cellsVessel)? `${fmt(state.cellsVessel,6)} cells` : '0 cells';

  // ★ “式どおり”の値をそのまま表示（負の値もそのまま）
  document.getElementById('VsNeeded').textContent  = isFinite(state.VsNeeded_raw)? `${fmt(state.VsNeeded_raw,6)} mL` : '0 mL';
  document.getElementById('VmedNeeded').textContent= isFinite(state.VmedNeeded_raw)? `${fmt(state.VmedNeeded_raw,6)} mL` : '0 mL';
}

document.getElementById('calcCount').addEventListener('click',()=>{
  calcCounts();
  renderCountsToStory();
  renderAllToSummary();
});

document.getElementById('calcVolumes').addEventListener('click',()=>{
  calcCounts(); // 前提

  const Vorig_uL = num(document.getElementById('Vorig_uL').value);
  const Vtb_uL   = num(document.getElementById('Vtb_uL').value);
  const Vwell    = num(document.getElementById('Vwell').value);   // 容器液量[mL]
  const Vfreeze  = num(document.getElementById('Vfreeze').value);
  const Ct       = num(document.getElementById('Ct').value);      // 目標濃度

  const mixVol_uL = (isFinite(Vorig_uL)? Vorig_uL:0) + (isFinite(Vtb_uL)? Vtb_uL:0);
  const DF = (isFinite(Vorig_uL) && Vorig_uL>0) ? (mixVol_uL / Vorig_uL) : 1;

  // 濃度（1大区画=1e-4 mL → ×10^4）
  const Clive  = state.avgL>0 ? state.avgL * DF * 1e4 : 0;
  const Ctotal = state.avgT>0 ? state.avgT * DF * 1e4 : 0;

  // 個数
  const tubeV  = isFinite(Vfreeze)? Vfreeze : 0;
  const cellsTube   = (tubeV>0 && Ctotal>0) ? (tubeV * Ctotal) : 0;
  const vesselV = isFinite(Vwell)? Vwell : 0;
  const cellsVessel = (vesselV>0 && Clive>0) ? (Clive * vesselV) : 0;

  // ★ 継代（式どおりの“生”値）: Vs_raw = 容器液量×(Ct/Clive), Vmed_raw = 容器液量−Vs_raw
  let Vs_raw = NaN, Vmed_raw = NaN, Vs_disp = NaN, Vmed_disp = NaN, guide = '';
  if (isFinite(Ct) && Ct>0 && Clive>0 && vesselV>0){
    Vs_raw   = vesselV * (Ct / Clive);
    Vmed_raw = vesselV - Vs_raw;
    // ガイド表示用（負の培地は0に丸め、注意書きを付ける）
    Vs_disp   = Vs_raw;
    Vmed_disp = Vmed_raw < 0 ? 0 : Vmed_raw;
    if (Vmed_raw < 0) guide = '（※ 目標がこすぎるので濃縮が必要）';
  }

  Object.assign(state,{
    Vorig_uL, Vtb_uL, mixVol_uL, DF,
    Clive, Ctotal, Vfreeze:tubeV, Vwell:vesselV, Ct,
    cellsTube, cellsVessel,
    VsNeeded_raw: Vs_raw, VmedNeeded_raw: Vmed_raw, // まとめ欄は“式どおり”
    VsNeeded: Vs_disp, VmedNeeded: Vmed_disp        // おはなしは丸め表示
  });

  // おはなし（実務向けに丸め表示）
  const s=document.getElementById('story');
  s.innerHTML += `<br><br>🧪 計数液量 <span class="num">${fmt(mixVol_uL,6)}</span> µL、希釈倍率 DF <span class="num">${fmt(DF,6)}</span> 倍。<br>
  生細胞濃度 <span class="num">${sci(Clive,2)}</span> cells/mL、全細胞濃度 <span class="num">${sci(Ctotal,2)}</span> cells/mL。<br>
  凍結チューブ（${fmt(tubeV,2)} mL）→ <span class="num">${fmt(cellsTube,6)}</span> cells、容器（${fmt(vesselV,2)} mL）→ <span class="num">${fmt(cellsVessel,6)}</span> live cells。` +
  (isFinite(Ct)&&Ct>0 && isFinite(vesselV)&&vesselV>0
    ? `<br><br>🎯 目標濃度 <span class="num">${sci(Ct,2)}</span> cells/mL・容器量 ${fmt(vesselV,2)} mL のとき、<br>
       細胞液 <span class="num">${isFinite(state.VsNeeded)?fmt(state.VsNeeded,6):'0'}</span> mL ＋ 培地 <span class="num">${isFinite(state.VmedNeeded)?fmt(state.VmedNeeded,6):'0'}</span> mL ${guide}`
    : ''
  );

  renderAllToSummary();
});

document.getElementById('clearCount').addEventListener('click',()=>{
  document.querySelectorAll('#tbl input').forEach(i=>i.value='');
  document.querySelectorAll('#tbl .total').forEach(td=>td.textContent='');
  state = {sumL:0,sumD:0,sumT:0,avgL:0,avgD:0,avgT:0,viab:0,
           Vorig_uL:0,Vtb_uL:0,mixVol_uL:0,DF:1,Clive:0,Ctotal:0,Vfreeze:0,Vwell:0,Ct:NaN,
           cellsTube:0,cellsVessel:0,VsNeeded_raw:0,VmedNeeded_raw:0,VsNeeded:0,VmedNeeded:0};
  document.getElementById('story').innerHTML='ここに結果が出ます。上で数字を入れてボタンをおしてね。';
  renderAllToSummary();
});
document.getElementById('clearVolumes').addEventListener('click',()=>{
  ['Vorig_uL','Vtb_uL','Vwell','Vfreeze','Ct'].forEach(id=>document.getElementById(id).value='');
  Object.assign(state,{Vorig_uL:0,Vtb_uL:0,mixVol_uL:0,DF:1,Clive:0,Ctotal:0,Vfreeze:0,Vwell:0,Ct:NaN,
                       cellsTube:0,cellsVessel:0,VsNeeded_raw:0,VmedNeeded_raw:0,VsNeeded:0,VmedNeeded:0});
  renderAllToSummary();
});

// 初期描画
renderAllToSummary();
</script>
