<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>èª°ã§ã‚‚ã‚ã‹ã‚‹ç´°èƒåŸ¹é¤Šè¨ˆç®—æ©Ÿ</title>
<style>
  :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --accent:#38bdf8; --text:#e5e7eb; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",Arial;}
  header{padding:18px 20px; border-bottom:1px solid #1f2937; background:linear-gradient(180deg,#0b1222,#0f172a 60%);}
  h1{margin:0; font-size:clamp(20px,4.5vw,28px)}
  main{max-width:980px; margin:0 auto; padding:16px}
  section{background:rgba(17,24,39,.7); border:1px solid #233044; border-radius:16px; padding:14px; margin-bottom:16px}
  h2{margin:0 0 10px 0; font-size:18px}
  .grid{display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
  .field{display:flex; flex-direction:column; gap:6px;}
  label{font-size:13px; color:var(--muted)}
  input,button{border:1px solid #2a3a52; background:#0b1222; color:#e5e7eb; border-radius:12px; padding:12px; font-size:16px; outline:none}
  input:focus{border-color:var(--accent); box-shadow:0 0 0 2px rgba(56,189,248,.15)}
  button{cursor:pointer; background:#1e293b}
  table{width:100%; border-collapse:collapse; font-size:16px; margin-top:8px}
  th,td{border-bottom:1px solid #233044; padding:10px; text-align:center}
  th{color:#a8b3c7}
  .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  .story{line-height:1.9; font-size:18px; background:#0b1324; border:1px solid #263650; border-radius:16px; padding:14px}
  .num{font-weight:800; color:#38bdf8}
  .mini{font-size:12px; color:#94a3b8}
  .big{font-size:20px}
  .kv{display:grid; grid-template-columns:minmax(230px,1fr) 1fr; gap:8px 16px; align-items:center}
  .kv .k{color:#cbd5e1}
</style>
</head>
<body>
<header>
  <h1>èª°ã§ã‚‚ã‚ã‹ã‚‹ç´°èƒåŸ¹é¤Šè¨ˆç®—æ©Ÿ</h1>
  <div class="mini">æ•°å­—ã‚’å…¥ã‚Œã¦ãƒœã‚¿ãƒ³ã‚’ãŠã™ã ã‘ï¼</div>
</header>
<main>

<!-- â‘  ç´°èƒã‚’æ•°ãˆãŸå›æ•° -->
<section>
  <h2>â‘  ç´°èƒã‚’æ•°ãˆãŸå›æ•°</h2>
  <div class="mini">å„è¡Œã¯ãƒ˜ãƒ¢ã‚µã‚¤ãƒˆãƒ¡ãƒ¼ã‚¿ãƒ¼ã®å¤§ãã„ãƒã‚¹1ã¤åˆ†ã€‚ãƒ‡ãƒ•ã‚©4å›ã€å¿…è¦ãªã‚‰ã€Œè¡Œã‚’è¿½åŠ ã€ã€‚</div>
  <table id="tbl">
    <thead><tr><th>#</th><th>ç”Ÿãã¦ã„ã‚‹ç´°èƒ</th><th>æ­»ã‚“ã§ã„ã‚‹ç´°èƒ</th><th>åˆè¨ˆ</th></tr></thead>
    <tbody>
      <tr><td>1</td><td><input class="live" inputmode="decimal"></td><td><input class="dead" inputmode="decimal"></td><td class="total"></td></tr>
      <tr><td>2</td><td><input class="live" inputmode="decimal"></td><td><input class="dead" inputmode="decimal"></td><td class="total"></td></tr>
      <tr><td>3</td><td><input class="live" inputmode="decimal"></td><td><input class="dead" inputmode="decimal"></td><td class="total"></td></tr>
      <tr><td>4</td><td><input class="live" inputmode="decimal"></td><td><input class="dead" inputmode="decimal"></td><td class="total"></td></tr>
    </tbody>
  </table>
  <div class="btns">
    <button id="addRow">ï¼‹ è¡Œã‚’è¿½åŠ </button>
    <button id="calcCount" class="big">âœ… è¨ˆæ•°ã‚’è¨ˆç®—</button>
    <button id="clearCount">ã‚¯ãƒªã‚¢</button>
  </div>
</section>

<!-- â‘¡ å…¥åŠ›ï¼ˆä½“ç©ãªã©ï¼‰ -->
<section>
  <h2>â‘¡ å…¥åŠ›ï¼ˆä½“ç©ãªã©ï¼‰</h2>
  <div class="grid">
    <div class="field"><label>è¨ˆæ•°ã§ä½¿ã£ãŸç´°èƒæ¶²é‡ï¼ˆåŸæ¶², <b>ÂµL</b>ï¼‰</label><input id="Vorig_uL" type="number" step="any" placeholder="ä¾‹ï¼š100"></div>
    <div class="field"><label>è¨ˆæ•°ã§ä½¿ã£ãŸãƒˆãƒªãƒ‘ãƒ³ãƒ–ãƒ«ãƒ¼æ¶²é‡ï¼ˆ<b>ÂµL</b>ï¼‰</label><input id="Vtb_uL" type="number" step="any" placeholder="ä¾‹ï¼š100"></div>
    <div class="field"><label>åŸ¹é¤Šå®¹å™¨å†…ã®æ¶²é‡ï¼ˆmLï¼‰</label><input id="Vwell" type="number" step="any" placeholder="ä¾‹ï¼š10"></div>
    <div class="field"><label>å‡çµãƒãƒ¥ãƒ¼ãƒ–1æœ¬ã®ä½“ç©ï¼ˆmLãƒ»ä»»æ„ï¼‰</label><input id="Vfreeze" type="number" step="any" placeholder="ä¾‹ï¼š1"></div>
    <div class="field"><label>ç›®æ¨™ã®æ¿ƒåº¦ Ctï¼ˆcells/mLãƒ»ä»»æ„ï¼‰</label><input id="Ct" type="number" step="any" placeholder="ä¾‹ï¼š1.0e6"></div>
    <div class="field"><label>ç›®æ¨™ã®ä½“ç©ï¼ˆmLãƒ»ä»»æ„ï¼‰</label><input id="Vtarget" type="number" step="any" placeholder="ä¾‹ï¼š10"></div>
  </div>
  <div class="btns">
    <button id="calcVolumes" class="big">ğŸ§ª ä½“ç©ãƒ»æ¿ƒåº¦ã‚’è¨ˆç®—</button>
    <button id="clearVolumes">ã‚¯ãƒªã‚¢</button>
  </div>
</section>

<!-- â‘¢ çµæœï¼ˆæ–‡ç« ï¼‰ -->
<section>
  <h2>â‘¢ è¨ˆç®—çµæœï¼ˆã‚„ã•ã—ã„èª¬æ˜ï¼‰</h2>
  <div id="story" class="story">
    ã“ã“ã«çµæœãŒå‡ºã¾ã™ã€‚ä¸Šã§æ•°å­—ã‚’å…¥ã‚Œã¦ãƒœã‚¿ãƒ³ã‚’ãŠã—ã¦ã­ã€‚
  </div>
</section>

<!-- â‘£ ã¾ã¨ã‚ï¼ˆå¼ã©ãŠã‚Šã®æ•°å€¤ãƒªã‚¹ãƒˆï¼‰ -->
<section>
  <h2>â‘£ ã¾ã¨ã‚ï¼ˆå¼ã©ãŠã‚Šï¼‰</h2>
  <div id="summary" class="story">
    <div class="kv">
      <div class="k">ç”Ÿç´°èƒæ•°ã®åˆè¨ˆ</div><div id="sumLive">0</div>
      <div class="k">ç”Ÿç´°èƒæ•°ã®å¹³å‡</div><div id="avgLive">0</div>
      <div class="k">æ­»ç´°èƒæ•°ã®åˆè¨ˆ</div><div id="sumDead">0</div>
      <div class="k">æ­»ç´°èƒæ•°ã®å¹³å‡</div><div id="avgDead">0</div>
      <div class="k">å…¨ç´°èƒæ•°ã®åˆè¨ˆ</div><div id="sumTotal">0</div>
      <div class="k">å…¨ç´°èƒæ•°ã®å¹³å‡</div><div id="avgTotal">0</div>
      <div class="k">è¨ˆæ•°æ¶²é‡ï¼ˆç´°èƒæ¶² + ãƒˆãƒªãƒ‘ãƒ³ãƒ–ãƒ«ãƒ¼ï¼‰</div><div id="mixVol">0 ÂµL</div>
      <div class="k">å¸Œé‡ˆå€ç‡ï¼ˆå¿…è¦æ¶²é‡ Ã· ç´°èƒæ¶²é‡ï¼‰</div><div id="DF">1</div>
      <div class="k">ç”Ÿå­˜ç‡ï¼ˆç”Ÿå¹³å‡ Ã· å…¨å¹³å‡ Ã— 100ï¼‰</div><div id="viab">0 %</div>
      <div class="k">ç”Ÿç´°èƒæ¿ƒåº¦ï¼ˆç”Ÿå¹³å‡ Ã— DF Ã— 10^4ï¼‰</div><div id="Clive">0 cells/mL</div>
      <div class="k">å…¨ç´°èƒæ¿ƒåº¦ï¼ˆå…¨å¹³å‡ Ã— DF Ã— 10^4ï¼‰</div><div id="Ctotal">0 cells/mL</div>
      <div class="k">å‡çµãƒãƒ¥ãƒ¼ãƒ–ä¸­ã®å…¨ç´°èƒæ•°ï¼ˆä½“ç©[mL] Ã— å…¨ç´°èƒæ¿ƒåº¦ï¼‰</div><div id="cellsTube">0 cells</div>
      <div class="k">åŸ¹é¤Šå®¹å™¨å†…ã®ç”Ÿç´°èƒæ•°ï¼ˆç”Ÿç´°èƒæ¿ƒåº¦ Ã— å®¹å™¨æ¶²é‡[mL]ï¼‰</div><div id="cellsVessel">0 cells</div>
      <div class="k">ç›®æ¨™ã®ä½“ç©</div><div id="Vtarget_out">0 mL</div>
      <div class="k">ç¶™ä»£åŸ¹é¤Šã«å¿…è¦ãªç´°èƒæ¶²é‡ï¼ˆV<sub>target</sub> Ã— Ct/Cliveï¼‰</div><div id="VsNeeded">0 mL</div>
      <div class="k">ç¶™ä»£åŸ¹é¤Šã«å¿…è¦ãªåŸ¹åœ°ï¼ˆV<sub>target</sub> âˆ’ å¿…è¦ç´°èƒæ¶²é‡ï¼‰</div><div id="VmedNeeded">0 mL</div>
    </div>
  </div>
</section>

</main>

<script>
function num(v){ if(v==null||v==='') return NaN; const s=String(v).replace(/[,\\s]/g,''); const x=parseFloat(s); return isFinite(x)?x:NaN; }
function fmt(v,d=6){ return isFinite(v)?Number(v).toLocaleString(undefined,{maximumSignificantDigits:d}):'0'; }
/* æ¿ƒåº¦ã ã‘æŒ‡æ•°è¡¨è¨˜ï¼ˆ10^nï¼‰ã§è¡¨ç¤º */
function sci(v, digits=2){ if(!isFinite(v)) return '0'; if(v===0) return '0'; const exp=Number(v).toExponential(digits); const [base,e]=exp.split('e'); const exponent=parseInt(e,10); return `${base} Ã— 10<sup>${exponent}</sup>`; }

let state = {
  // è¨ˆæ•°çµæœ
  sumL:0, sumD:0, sumT:0, avgL:0, avgD:0, avgT:0, viab:0,
  // ä½“ç©å…¥åŠ›
  Vorig_uL:0, Vtb_uL:0, Vwell:0, Vfreeze:0, Ct:NaN, Vtarget:0,
  // æ´¾ç”Ÿ
  mixVol_uL:0, DF:1, Clive:0, Ctotal:0, cellsTube:0, cellsVessel:0,
  // ç¶™ä»£ï¼šå¼ã©ãŠã‚Šã®â€œç”Ÿå€¤â€ï¼ˆè² ã‚‚ä¿æŒï¼‰
  VsNeeded_raw:0, VmedNeeded_raw:0,
  // ãŠã¯ãªã—è¡¨ç¤ºç”¨ï¼ˆè² ã®åŸ¹åœ°ã¯0ã«ä¸¸ã‚ï¼‰
  VsNeeded:0, VmedNeeded:0
};

document.getElementById('addRow').addEventListener('click',()=>{
  const tb=document.querySelector('#tbl tbody');
  const i=tb.querySelectorAll('tr').length+1;
  const tr=document.createElement('tr');
  tr.innerHTML = `<td>${i}</td><td><input class="live" inputmode="decimal"></td><td><input class="dead" inputmode="decimal"></td><td class="total"></td>`;
  tb.appendChild(tr);
});

function calcCounts(){
  const rows=[...document.querySelectorAll('#tbl tbody tr')];
  let sumL=0,sumD=0,sumT=0,n=0;
  rows.forEach(tr=>{
    const l=num(tr.querySelector('.live').value);
    const d=num(tr.querySelector('.dead').value);
    const t=(isFinite(l)?l:0)+(isFinite(d)?d:0);
    tr.querySelector('.total').textContent = isFinite(t)? fmt(t,6) : '';
    if(isFinite(l)||isFinite(d)){ n++; if(isFinite(l)) sumL+=l; if(isFinite(d)) sumD+=d; sumT+=t; }
  });
  const avgL = n? sumL/n : 0;
  const avgD = n? sumD/n : 0;
  const avgT = n? sumT/n : 0;
  const viab = avgT>0 ? (avgL/avgT*100) : 0;
  Object.assign(state,{sumL, sumD, sumT, avgL, avgD, avgT, viab});
}

function renderCountsToStory(){
  const s=document.getElementById('story');
  s.innerHTML = `ğŸ‘€ ç”Ÿãã¦ã„ã‚‹ç´°èƒ åˆè¨ˆ <span class="num">${fmt(state.sumL,6)}</span>ã€å¹³å‡ <span class="num">${fmt(state.avgL,6)}</span><br>
ğŸ˜´ æ­»ã‚“ã§ã„ã‚‹ç´°èƒ åˆè¨ˆ <span class="num">${fmt(state.sumD,6)}</span>ã€å¹³å‡ <span class="num">${fmt(state.avgD,6)}</span><br>
â• å…¨éƒ¨ã®åˆè¨ˆ <span class="num">${fmt(state.sumT,6)}</span>ã€å¹³å‡ <span class="num">${fmt(state.avgT,6)}</span><br>
ğŸ’š ç”Ÿå­˜ç‡ <span class="num">${state.avgT>0? state.viab.toFixed(2):'0'}</span> %`;
}

function renderAllToSummary(){
  // è¨ˆæ•°
  document.getElementById('sumLive').textContent = fmt(state.sumL,6);
  document.getElementById('avgLive').textContent = fmt(state.avgL,6);
  document.getElementById('sumDead').textContent = fmt(state.sumD,6);
  document.getElementById('avgDead').textContent = fmt(state.avgD,6);
  document.getElementById('sumTotal').textContent = fmt(state.sumT,6);
  document.getElementById('avgTotal').textContent = fmt(state.avgT,6);

  // ä½“ç©ãƒ»DF
  document.getElementById('mixVol').textContent = `${fmt(state.mixVol_uL,6)} ÂµL`;
  document.getElementById('DF').textContent = fmt(state.DF,6);
  document.getElementById('viab').textContent = `${state.avgT>0? state.viab.toFixed(2):'0'} %`;

  // æ¿ƒåº¦ï¼ˆæŒ‡æ•°è¡¨è¨˜ï¼‰
  document.getElementById('Clive').innerHTML = `${sci(state.Clive,2)} cells/mL`;
  document.getElementById('Ctotal').innerHTML = `${sci(state.Ctotal,2)} cells/mL`;

  // å€‹æ•°
  document.getElementById('cellsTube').textContent   = isFinite(state.cellsTube)? `${fmt(state.cellsTube,6)} cells` : '0 cells';
  document.getElementById('cellsVessel').textContent = isFinite(state.cellsVessel)? `${fmt(state.cellsVessel,6)} cells` : '0 cells';

  // ç›®æ¨™ä½“ç© & ç¶™ä»£ï¼ˆå¼ã©ãŠã‚Šï¼‰
  document.getElementById('Vtarget_out').textContent = `${fmt(state.Vtarget,6)} mL`;
  document.getElementById('VsNeeded').textContent    = isFinite(state.VsNeeded_raw)? `${fmt(state.VsNeeded_raw,6)} mL` : '0 mL';
  document.getElementById('VmedNeeded').textContent  = isFinite(state.VmedNeeded_raw)? `${fmt(state.VmedNeeded_raw,6)} mL` : '0 mL';
}

document.getElementById('calcCount').addEventListener('click',()=>{
  calcCounts();
  renderCountsToStory();
  renderAllToSummary();
});

document.getElementById('calcVolumes').addEventListener('click',()=>{
  calcCounts(); // å‰æ

  // å…¥åŠ›å€¤
  const Vorig_uL = num(document.getElementById('Vorig_uL').value);
  const Vtb_uL   = num(document.getElementById('Vtb_uL').value);
  const Vwell    = num(document.getElementById('Vwell').value);     // å®¹å™¨æ¶²é‡[mL]
  const Vfreeze  = num(document.getElementById('Vfreeze').value);
  const Ct       = num(document.getElementById('Ct').value);        // ç›®æ¨™æ¿ƒåº¦
  const Vtarget  = num(document.getElementById('Vtarget').value);   // ç›®æ¨™ä½“ç©[mL]

  // è¨ˆæ•°æ¶²é‡ã¨å¸Œé‡ˆå€ç‡
  const mixVol_uL = (isFinite(Vorig_uL)? Vorig_uL:0) + (isFinite(Vtb_uL)? Vtb_uL:0);
  const DF = (isFinite(Vorig_uL) && Vorig_uL>0) ? (mixVol_uL / Vorig_uL) : 1;

  // æ¿ƒåº¦ï¼ˆ1å¤§åŒºç”»=1e-4 mL â†’ Ã—10^4ï¼‰
  const Clive  = state.avgL>0 ? state.avgL * DF * 1e4 : 0;
  const Ctotal = state.avgT>0 ? state.avgT * DF * 1e4 : 0;

  // å€‹æ•°ï¼ˆå‡çµ/å®¹å™¨ï¼‰
  const tubeV  = isFinite(Vfreeze)? Vfreeze : 0;
  const cellsTube   = (tubeV>0 && Ctotal>0) ? (tubeV * Ctotal) : 0;
  const vesselV = isFinite(Vwell)? Vwell : 0;
  const cellsVessel = (vesselV>0 && Clive>0) ? (Clive * vesselV) : 0;

  // ç¶™ä»£ï¼ˆå¼ã©ãŠã‚Šï¼šVtargetã‚’ä½¿ç”¨ï¼‰
  let Vs_raw=NaN, Vmed_raw=NaN, Vs_disp=NaN, Vmed_disp=NaN, guide='';
  if (isFinite(Ct) && Ct>0 && Clive>0 && isFinite(Vtarget) && Vtarget>0){
    Vs_raw   = Vtarget * (Ct / Clive);  // å¼ã©ãŠã‚Š
    Vmed_raw = Vtarget - Vs_raw;        // å¼ã©ãŠã‚Š
    // ãŠã¯ãªã—å‘ã‘ã®ä¸¸ã‚
    Vs_disp   = Vs_raw;
    Vmed_disp = Vmed_raw < 0 ? 0 : Vmed_raw;
    if (Vmed_raw < 0) guide = 'ï¼ˆâ€» ç›®æ¨™ãŒã“ã™ãã‚‹ã®ã§æ¿ƒç¸®ãŒå¿…è¦ï¼‰';
  }

  Object.assign(state,{
    Vorig_uL, Vtb_uL, Vwell:vesselV, Vfreeze:tubeV, Ct, Vtarget,
    mixVol_uL, DF, Clive, Ctotal, cellsTube, cellsVessel,
    VsNeeded_raw:Vs_raw, VmedNeeded_raw:Vmed_raw,
    VsNeeded:Vs_disp, VmedNeeded:Vmed_disp
  });

  // ãŠã¯ãªã—è¡¨ç¤º
  const s=document.getElementById('story');
  s.innerHTML = `ğŸ§ª è¨ˆæ•°æ¶²é‡ <span class="num">${fmt(mixVol_uL,6)}</span> ÂµLã€å¸Œé‡ˆå€ç‡ DF <span class="num">${fmt(DF,6)}</span> å€ã€‚<br>
ç”Ÿç´°èƒæ¿ƒåº¦ <span class="num">${sci(Clive,2)}</span> cells/mLã€å…¨ç´°èƒæ¿ƒåº¦ <span class="num">${sci(Ctotal,2)}</span> cells/mLã€‚<br>
å‡çµãƒãƒ¥ãƒ¼ãƒ–ï¼ˆ${fmt(tubeV,2)} mLï¼‰â†’ <span class="num">${fmt(cellsTube,6)}</span> cellsã€å®¹å™¨ï¼ˆ${fmt(vesselV,2)} mLï¼‰â†’ <span class="num">${fmt(cellsVessel,6)}</span> live cellsã€‚` +
  (isFinite(Ct)&&Ct>0 && isFinite(Vtarget)&&Vtarget>0
    ? `<br><br>ğŸ¯ ç›®æ¨™æ¿ƒåº¦ <span class="num">${sci(Ct,2)}</span> cells/mL ã® <span class="num">${fmt(Vtarget,6)}</span> mL ã‚’ã¤ãã‚‹ã«ã¯ã€<br>
       ç´°èƒæ¶² <span class="num">${isFinite(state.VsNeeded)?fmt(state.VsNeeded,6):'0'}</span> mL ï¼‹ åŸ¹åœ° <span class="num">${isFinite(state.VmedNeeded)?fmt(state.VmedNeeded,6):'0'}</span> mL ${guide}`
    : ''
  );

  renderAllToSummary();
});

document.getElementById('clearCount').addEventListener('click',()=>{
  document.querySelectorAll('#tbl input').forEach(i=>i.value='');
  document.querySelectorAll('#tbl .total').forEach(td=>td.textContent='');
  state = {sumL:0,sumD:0,sumT:0,avgL:0,avgD:0,avgT:0,viab:0,
           Vorig_uL:0,Vtb_uL:0,Vwell:0,Vfreeze:0,Ct:NaN,Vtarget:0,
           mixVol_uL:0,DF:1,Clive:0,Ctotal:0,cellsTube:0,cellsVessel:0,
           VsNeeded_raw:0,VmedNeeded_raw:0,VsNeeded:0,VmedNeeded:0};
  document.getElementById('story').innerHTML='ã“ã“ã«çµæœãŒå‡ºã¾ã™ã€‚ä¸Šã§æ•°å­—ã‚’å…¥ã‚Œã¦ãƒœã‚¿ãƒ³ã‚’ãŠã—ã¦ã­ã€‚';
  renderAllToSummary();
});
document.getElementById('clearVolumes').addEventListener('click',()=>{
  ['Vorig_uL','Vtb_uL','Vwell','Vfreeze','Ct','Vtarget'].forEach(id=>document.getElementById(id).value='');
  Object.assign(state,{Vorig_uL:0,Vtb_uL:0,Vwell:0,Vfreeze:0,Ct:NaN,Vtarget:0,
                       mixVol_uL:0,DF:1,Clive:0,Ctotal:0,cellsTube:0,cellsVessel:0,
                       VsNeeded_raw:0,VmedNeeded_raw:0,VsNeeded:0,VmedNeeded:0});
  renderAllToSummary();
});

// åˆæœŸæç”»
renderAllToSummary();
</script>
</body>
</html>

